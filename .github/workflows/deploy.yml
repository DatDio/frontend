name: Frontend CI/CD

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 1: TRIGGER - Khi nÃ o workflow cháº¡y?
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on:
  push:
    branches: [main]          # Cháº¡y khi push vÃ o branch main
  pull_request:
    branches: [main]          # Cháº¡y khi táº¡o PR vÃ o main (chá»‰ build, ko deploy)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHáº¦N 2: JOBS - CÃ¡c cÃ´ng viá»‡c cáº§n thá»±c hiá»‡n
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: BUILD - Cháº¡y trÃªn GitHub Runner (mÃ¡y áº£o Ubuntu cá»§a GitHub)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest    # Sá»­ dá»¥ng mÃ¡y áº£o Ubuntu má»›i nháº¥t cá»§a GitHub (miá»…n phÃ­)

    steps:
      # BÆ°á»›c 1: Clone code tá»« repo vá» mÃ¡y áº£o GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # BÆ°á»›c 2: CÃ i Ä‘áº·t Node.js 20
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'           # Version Node.js
          cache: 'npm'                 # Cache npm dependencies Ä‘á»ƒ láº§n sau build nhanh hÆ¡n

      # BÆ°á»›c 3: CÃ i Ä‘áº·t dependencies tá»« package-lock.json
      - name: Install dependencies
        run: npm ci                    # npm ci nhanh hÆ¡n npm install, dÃ¹ng cho CI/CD

      # BÆ°á»›c 4: Build Angular app cho production
      - name: Build Angular app
        run: npm run build -- --configuration=production

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: DEPLOY - SSH vÃ o VPS vÃ  deploy
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    runs-on: ubuntu-latest
    needs: build                       # âš ï¸ Pháº£i Ä‘á»£i job "build" hoÃ n thÃ nh trÆ°á»›c
    
    # Äiá»u kiá»‡n: Chá»‰ deploy khi PUSH vÃ o main (khÃ´ng deploy khi táº¡o PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      # SSH vÃ o VPS vÃ  cháº¡y cÃ¡c lá»‡nh deploy
      - name: Deploy Frontend to VPS
        uses: appleboy/ssh-action@v1.0.3   # Action SSH phá»• biáº¿n nháº¥t
        with:
          # ThÃ´ng tin káº¿t ná»‘i VPS (láº¥y tá»« GitHub Secrets)
          host: ${{ secrets.VPS_HOST }}         # IP hoáº·c domain VPS
          username: ${{ secrets.VPS_USERNAME }} # Username SSH (vd: ubuntu, root)
          key: ${{ secrets.VPS_SSH_KEY }}       # Private key SSH
          port: ${{ secrets.VPS_PORT }}         # Port SSH (thÆ°á»ng lÃ  22)
          
          # Script cháº¡y trÃªn VPS
          script: |
            set -e  # Dá»«ng ngay náº¿u cÃ³ lá»—i
            
            echo "ğŸ“ Navigating to project..."
            cd ${{ secrets.PROJECT_PATH }}      # VÃ o /opt/mailshop
            
            echo "ğŸ“¥ Pulling latest frontend code..."
            cd frontend                         # VÃ o folder frontend
            git fetch --all                     # Fetch táº¥t cáº£ changes tá»« remote
            git reset --hard origin/main        # Reset vá» commit má»›i nháº¥t cá»§a origin/main
            cd ..                               # Quay láº¡i /opt/mailshop
            
            echo "ğŸ”„ Rebuilding frontend container..."
            docker-compose stop frontend                  # Dá»«ng container cÅ©
            docker-compose build --no-cache frontend      # Build láº¡i image (khÃ´ng dÃ¹ng cache)
            docker-compose up -d frontend                 # Cháº¡y container má»›i á»Ÿ background
            
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f               # XÃ³a images cÅ© khÃ´ng dÃ¹ng
            
            echo "ğŸ“Š Container status:"
            docker-compose ps frontend          # Hiá»ƒn thá»‹ tráº¡ng thÃ¡i container
            
            echo "âœ… Frontend deployed successfully!"
