name: Frontend CI/CD (Zero-Downtime)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Angular app
        run: npm run build -- --configuration=production

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Zero-Downtime Deploy Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script_stop: true
          script: |
            set -e
            
            PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
            NGINX_CONF="/etc/nginx/sites-enabled/mailshop"
            
            echo "=========================================="
            echo "   Zero-Downtime Frontend Deployment"
            echo "=========================================="
            
            cd "$PROJECT_PATH"
            
            # Determine current active slot from nginx config
            if grep -q "127.0.0.1:4001" "$NGINX_CONF" 2>/dev/null; then
              ACTIVE_SLOT="blue"
              NEXT_SLOT="green"
              NEXT_PORT=4002
            else
              ACTIVE_SLOT="green"
              NEXT_SLOT="blue"
              NEXT_PORT=4001
            fi
            
            echo "üìä Active slot: $ACTIVE_SLOT"
            echo "üöÄ Deploying to: $NEXT_SLOT (port $NEXT_PORT)"
            
            # Step 1: Pull latest code
            echo "üì• Step 1: Pulling latest frontend code..."
            cd frontend
            git fetch --all
            git reset --hard origin/main
            cd ..
            
            # Step 2: Stop old container for next slot (cleanup)
            echo "üßπ Step 2: Cleaning up old $NEXT_SLOT container..."
            docker stop frontend-$NEXT_SLOT 2>/dev/null || true
            docker rm frontend-$NEXT_SLOT 2>/dev/null || true
            
            # Step 3: Build new image
            echo "üî® Step 3: Building frontend image..."
            docker compose -f docker-compose.yml build frontend
            
            # Step 4: Start new container on next slot port
            echo "üöÄ Step 4: Starting frontend-$NEXT_SLOT on port $NEXT_PORT..."
            docker run -d \
              --name frontend-$NEXT_SLOT \
              --network mailshop_mailshop-network \
              -p $NEXT_PORT:4000 \
              -e NODE_ENV=production \
              --restart always \
              mailshop-frontend:latest
            
            # Step 5: Wait for health check
            echo "üíì Step 5: Waiting for frontend health check..."
            for i in {1..30}; do
              if curl -sf "http://127.0.0.1:$NEXT_PORT" > /dev/null 2>&1; then
                echo ""
                echo "‚úÖ Frontend is healthy on port $NEXT_PORT!"
                break
              fi
              printf "."
              sleep 2
            done
            
            # Verify health check passed
            if ! curl -sf "http://127.0.0.1:$NEXT_PORT" > /dev/null 2>&1; then
              echo "‚ùå Health check failed! Rolling back..."
              docker stop frontend-$NEXT_SLOT 2>/dev/null || true
              docker rm frontend-$NEXT_SLOT 2>/dev/null || true
              exit 1
            fi
            
            # Step 6: Switch nginx to new slot
            echo "üîÑ Step 6: Switching Nginx to $NEXT_SLOT..."
            sudo sed -i "s|proxy_pass http://127.0.0.1:400[0-2]|proxy_pass http://127.0.0.1:$NEXT_PORT|g" "$NGINX_CONF"
            sudo nginx -t && sudo nginx -s reload
            
            # Step 7: Wait for connections to drain
            echo "‚è≥ Step 7: Waiting for connections to drain (3s)..."
            sleep 3
            
            # Step 8: Stop old slot
            echo "üõë Step 8: Stopping old $ACTIVE_SLOT container..."
            docker stop frontend-$ACTIVE_SLOT 2>/dev/null || true
            docker rm frontend-$ACTIVE_SLOT 2>/dev/null || true
            
            # Cleanup old images
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            echo ""
            echo "=========================================="
            echo "   ‚úÖ Frontend Deployed Successfully!"
            echo "   Active slot: $NEXT_SLOT (port $NEXT_PORT)"
            echo "=========================================="

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "üíì Verifying deployment..."
            for i in {1..10}; do
              if curl -sf https://emailsieure.com > /dev/null 2>&1; then
                echo "‚úÖ Frontend verified successfully!"
                exit 0
              fi
              sleep 2
            done
            echo "‚ùå Verification failed!"
            exit 1
