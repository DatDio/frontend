<div class="container-fluid p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Quản lý sản phẩm</h1>

    <div class="col-md-4 text-end">
      <button class="btn btn-primary" (click)="onCreateClick()">
        <i class="bi bi-plus-circle"></i> Thêm sản phẩm
      </button>
    </div>
  </div>

  <!-- Search Form -->
  <div class="card mb-3">
    <div class="card-body">
      <form [formGroup]="formSearch" class="row g-3">
        <div class="col-md-3">
          <label for="nameInput" class="form-label">Tên sản phẩm</label>
          <input id="nameInput" type="text" class="form-control" placeholder="Tìm kiếm theo tên..."
            formControlName="name">
        </div>
        <div class="col-md-3">
          <label for="categorySelect" class="form-label">Danh mục</label>
          <select id="categorySelect" class="form-select" formControlName="categoryId">
            <option value="">Tất cả danh mục</option>
            @for (category of categories; track category.id) {
            <option [value]="category.id">{{ category.name }}</option>
            }
          </select>
        </div>
        <div class="col-md-3">
          <label for="statusSelect" class="form-label">Trạng thái</label>
          <app-active-status-select id="statusSelect" formControlName="status">
          </app-active-status-select>
        </div>
        <div class="col-md-3 d-flex align-items-end gap-2">
          <button type="button" class="btn btn-primary w-50" (click)="handleSearch()">
            <i class="bi bi-search"></i> Tìm kiếm
          </button>
          <button type="button" class="btn btn-secondary w-50" (click)="clearForm()">
            <i class="bi bi-arrow-clockwise"></i> Xóa bộ lọc
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col-md-6">
          <span class="text-muted">Tổng: {{ paginationConfig.totalElements }} sản phẩm</span>
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      @if (loading) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
      </div>
      } @else {
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th style="width: 50px; text-align: center;">STT</th>
              <th>Hình ảnh</th>
              <th>Tên sản phẩm</th>
              <th>Danh mục</th>
              <th>Nguồn</th>
              <th>Giá</th>
              <th>Kho chính</th>
              <th>Kho phụ</th>
              <th>Trạng thái</th>
              <th style="width: 100px; text-align: center;">Hành động</th>
            </tr>
          </thead>
          <tbody>
            @for (product of products; track product.id; let i = $index) {
            <tr>
              <td style="text-align: center; font-weight: 500;">
                {{ i + 1 + (paginationConfig.currentPage * paginationConfig.pageSize) }}
              </td>
              <td>
                @if (product.imageUrl) {
                <img [src]="product.imageUrl" alt="{{ product.name }}" class="product-thumbnail">
                } @else {
                <div class="product-placeholder">
                  <i class="bi bi-image"></i>
                </div>
                }
              </td>
              <td>{{ product.name }}</td>
              <td>{{ product.categoryName || product.categoryId }}</td>
              <td>
                @if (product.sourceType === 'EXTERNAL') {
                <span class="badge bg-info" title="Sản phẩm từ nguồn bên ngoài">
                  <i class="bi bi-cloud me-1"></i>External
                </span>
                } @else {
                <span class="badge bg-success" title="Sản phẩm từ kho nội bộ">
                  <i class="bi bi-house me-1"></i>Local
                </span>
                }
              </td>
              <td>{{ product.price}}</td>
              <td>
                @if (product.sourceType === 'EXTERNAL') {
                <span class="text-muted">-</span>
                } @else {
                <span class="badge bg-secondary" title="Kho chính (ẩn)">
                  <i class="bi bi-box-seam me-1"></i>{{ product.primaryQuantity || 0 }}
                </span>
                }
              </td>
              <td>
                @if (product.sourceType === 'EXTERNAL') {
                <span class="text-muted">API</span>
                } @else {
                <span class="badge bg-success" title="Kho phụ (hiển thị)">
                  <i class="bi bi-shop me-1"></i>{{ product.quantity }}
                </span>
                <small class="text-muted d-block">min: {{ product.minSecondaryStock || 500 }} | max: {{
                  product.maxSecondaryStock || 1000 }}</small>
                }
              </td>
              <td>
                <app-active-status-badge [status]="product.status"></app-active-status-badge>
              </td>
              <td style="text-align: center">
                <div class="action-buttons">
                  <button class="icon-btn info" (click)="onDetail(product)" title="Xem tài khoản">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="icon-btn warning" (click)="onEditClick(product)" title="Chỉnh sửa">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="icon-btn danger" (click)="onDeleteClick(product.id)" title="Xóa">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            }

            @if (products.length === 0) {
            <tr>
              <td colspan="10" class="text-center py-4 text-muted">
                Không có dữ liệu
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </div>

    <!-- Pagination -->
    @if (paginationConfig.totalPages > 0) {
    <div class="card-footer">
      <app-pagination [config]="paginationConfig" (pageChange)="handlePageChange($event)"
        (pageSizeChange)="selectPageSize($event)">
      </app-pagination>
    </div>
    }
  </div>
</div>

<!-- Create Modal -->
@if (showCreateModal) {
<app-product-create-modal [categories]="categories" (closeModal)="onCreateModalClose()"
  (successCreate)="onCreateSuccess()">
</app-product-create-modal>
}

<!-- Update Modal -->
@if (showUpdateModal && selectedProduct) {
<app-product-update-modal [product]="selectedProduct" [categories]="categories" (closeModal)="onUpdateModalClose()"
  (successUpdate)="onUpdateSuccess()">
</app-product-update-modal>
}

<!-- Source Type Selection Dialog -->
@if (showSourceTypeDialog) {
<div class="modal-overlay" (click)="onSourceTypeDialogClose()">
  <div class="source-type-dialog" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h5 class="mb-0">Chọn loại sản phẩm</h5>
      <button type="button" class="btn-close" (click)="onSourceTypeDialogClose()"></button>
    </div>
    <div class="dialog-body">
      <p class="text-muted mb-4">Vui lòng chọn nguồn sản phẩm bạn muốn tạo:</p>
      <div class="row g-3">
        <div class="col-6">
          <div class="source-card local" (click)="onSourceTypeSelect('LOCAL')">
            <i class="bi bi-house-fill source-icon"></i>
            <h6>Local</h6>
            <small class="text-muted">Sản phẩm từ kho nội bộ, quản lý số lượng và tài khoản thủ công</small>
          </div>
        </div>
        <div class="col-6">
          <div class="source-card external" (click)="onSourceTypeSelect('EXTERNAL')">
            <i class="bi bi-cloud-fill source-icon"></i>
            <h6>External</h6>
            <small class="text-muted">Sản phẩm từ API bên ngoài, tự động đồng bộ stock và đặt hàng</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
}