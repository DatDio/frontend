<div class="modal-backdrop" (click)="onClose()"></div>
<div class="modal-container">
    <div class="modal-content large">
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="fas fa-plug me-2"></i>
                {{ isCreateMode ? 'Thêm Provider Mới' : 'Chỉnh Sửa Provider' }}
            </h5>
            <button type="button" class="btn-close" (click)="onClose()"></button>
        </div>

        <div class="modal-body">
            <!-- Tabs -->
            <ul class="nav nav-pills nav-fill mb-4">
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'basic'" (click)="onTabChange('basic')">
                        <i class="bi bi-gear me-1"></i> Cơ bản
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'product'" (click)="onTabChange('product')">
                        <i class="bi bi-box me-1"></i> Product API
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'order'" (click)="onTabChange('order')">
                        <i class="bi bi-cart me-1"></i> Order API
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'balance'" (click)="onTabChange('balance')">
                        <i class="bi bi-wallet2 me-1"></i> Balance
                    </a>
                </li>
            </ul>

            <form [formGroup]="form">
                <!-- Basic Tab -->
                @if (activeTab === 'basic') {
                <div class="config-section">
                    <div class="section-header">
                        <i class="bi bi-info-circle"></i>
                        <span>Thông tin cơ bản</span>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tên Provider <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" formControlName="name"
                                placeholder="VD: mail30s.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Base URL <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" formControlName="baseUrl"
                                placeholder="https://api.example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">API Key</label>
                            <input type="text" class="form-control" formControlName="apiKey"
                                placeholder="Nhập API Key từ provider">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Kiểu xác thực</label>
                            <select class="form-select" formControlName="authType">
                                <option value="HEADER">Header (Authorization)</option>
                                <option value="QUERY_PARAM">Query Param (?api_key=xxx)</option>
                            </select>
                        </div>
                        @if (form.get('authType')?.value === 'HEADER') {
                        <div class="col-md-6">
                            <label class="form-label">Tên Header</label>
                            <input type="text" class="form-control" formControlName="authHeaderName"
                                placeholder="Authorization">
                        </div>
                        }
                        @if (form.get('authType')?.value === 'QUERY_PARAM') {
                        <div class="col-md-6">
                            <label class="form-label">Tên Query Param</label>
                            <input type="text" class="form-control" formControlName="authQueryParam"
                                placeholder="api_key">
                        </div>
                        }
                        <div class="col-md-6">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" formControlName="status">
                                <option [value]="1">Hoạt động</option>
                                <option [value]="0">Ngưng</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Interval (giây)</label>
                            <input type="number" class="form-control" formControlName="syncIntervalSeconds" min="60">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Ghi chú</label>
                            <textarea class="form-control" formControlName="notes" rows="2"
                                placeholder="Ghi chú thêm..."></textarea>
                        </div>
                    </div>
                </div>
                }

                <!-- Product Tab -->
                @if (activeTab === 'product') {
                <!-- API Endpoint Config -->
                <div class="config-section">
                    <div class="section-header">
                        <i class="bi bi-link-45deg"></i>
                        <span>API Endpoint</span>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Method</label>
                            <select class="form-select" formControlName="productListMethod">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                            <label class="form-label">Path</label>
                            <input type="text" class="form-control" formControlName="productListPath"
                                placeholder="/api/products">
                        </div>
                    </div>
                </div>

                <!-- Field Mappings -->
                <div class="config-section mt-3">
                    <div class="section-header">
                        <i class="bi bi-diagram-3"></i>
                        <span>Field Mappings</span>
                        <small class="text-muted ms-2">Nhấn nút <i class="bi bi-crosshair"></i> để chọn từ JSON</small>
                    </div>

                    <!-- Data Path -->
                    <div class="mb-3">
                        <label class="form-label d-flex align-items-center">
                            <span>Data Path</span>
                            <span class="badge bg-info ms-2">Mảng chứa sản phẩm</span>
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" formControlName="productListDataPath"
                                placeholder="data hoặc $.data">
                            <button type="button" class="btn btn-outline-secondary"
                                (click)="startPathSelection('productListDataPath')" [disabled]="!sampleItem">
                                <i class="bi bi-crosshair"></i>
                            </button>
                        </div>
                        <small class="text-muted">Đường dẫn đến mảng sản phẩm trong response</small>
                    </div>

                    <!-- Core Field Mapping Grid (required) -->
                    <div class="row g-2">
                        @for (field of [
                        {name: 'productIdPath', label: 'ID', icon: 'bi-key', required: true},
                        {name: 'productNamePath', label: 'Tên SP', icon: 'bi-tag', required: true},
                        {name: 'productPricePath', label: 'Giá', icon: 'bi-currency-dollar', required: true},
                        {name: 'productStockPath', label: 'Tồn kho', icon: 'bi-box-seam', required: false}
                        ]; track field.name) {
                        <div class="col-md-3">
                            <label class="form-label small">
                                <i class="bi {{ field.icon }} me-1"></i>{{ field.label }}
                                @if (field.required) {<span class="text-danger">*</span>}
                            </label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" [formControlName]="field.name"
                                    placeholder="id, name...">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="startPathSelection(field.name)" [disabled]="!sampleItem">
                                    <i class="bi bi-crosshair"></i>
                                </button>
                            </div>
                        </div>
                        }
                    </div>

                    <!-- Custom Fields Section -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0 small fw-bold">
                                <i class="bi bi-plus-square me-1"></i>Trường tùy chỉnh
                            </label>
                            <button type="button" class="btn btn-sm btn-outline-primary" (click)="addCustomField()">
                                <i class="bi bi-plus me-1"></i>Thêm trường
                            </button>
                        </div>
                        @if (customFields.length > 0) {
                        <div class="row g-2">
                            @for (cf of customFields; track $index) {
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" [(ngModel)]="cf.name"
                                    [ngModelOptions]="{standalone: true}"
                                    placeholder="Tên trường (vd: slug, description)">
                            </div>
                            <div class="col-md-5">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" [(ngModel)]="cf.path"
                                        [ngModelOptions]="{standalone: true}" placeholder="Path (vd: $.slug)">
                                    <button type="button" class="btn btn-outline-secondary"
                                        (click)="activePathField = 'custom_' + $index; showJsonPicker = true"
                                        [disabled]="!sampleItem">
                                        <i class="bi bi-crosshair"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-sm btn-outline-danger w-100"
                                    (click)="removeCustomField($index)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            }
                        </div>
                        } @else {
                        <div class="text-muted small">Chưa có trường tùy chỉnh. Click "Thêm trường" để thêm.</div>
                        }
                    </div>
                </div>


                <!-- Test Fetch Products -->
                @if (!isCreateMode) {
                <div class="config-section mt-3">
                    <div class="section-header">
                        <i class="bi bi-play-circle"></i>
                        <span>Test & JSON Mapping</span>
                    </div>

                    <!-- Sub Tabs Navigation -->
                    <ul class="nav nav-tabs nav-tabs-sm mb-3">
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeJsonTab === 'input'"
                                (click)="setJsonTab('input')">
                                <i class="bi bi-cloud-download me-1"></i>Fetch Test
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeJsonTab === 'fields'"
                                (click)="setJsonTab('fields')" [class.disabled]="!sampleItem">
                                <i class="bi bi-braces me-1"></i>Chọn Fields
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeJsonTab === 'preview'"
                                (click)="setJsonTab('preview')" [class.disabled]="externalProducts.length === 0">
                                <i class="bi bi-table me-1"></i>Kết quả ({{ externalProducts.length }})
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeJsonTab === 'raw'" (click)="setJsonTab('raw')"
                                [class.disabled]="!rawResponse">
                                <i class="bi bi-code me-1"></i>Raw JSON
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content border rounded p-3">
                        <!-- TAB 1: INPUT & FETCH -->
                        @if (activeJsonTab === 'input') {
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary" (click)="onFetchProducts()"
                                [disabled]="loadingProducts">
                                @if (loadingProducts) {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-cloud-download me-1"></i> Gọi API lấy danh sách sản phẩm
                            </button>

                            @if (fetchError) {
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                {{ fetchError }}
                            </div>
                            }
                        </div>
                        }

                        <!-- TAB 2: PICK FIELDS -->
                        @if (activeJsonTab === 'fields' && sampleItem) {
                        @if (activePathField) {
                        <div class="alert alert-info py-2 mb-2">
                            <i class="bi bi-crosshair me-1"></i>
                            Đang chọn cho trường: <strong>{{ activePathField }}</strong>
                            <span class="text-muted ms-2">- Click <i class="bi bi-check-circle"></i> để chọn path, hoặc click vào tên field để đi sâu vào</span>
                        </div>
                        } @else {
                        <div class="alert alert-warning py-2 mb-2">
                            <i class="bi bi-exclamation-circle me-1"></i>
                            Vui lòng click vào nút <i class="bi bi-crosshair"></i> ở các ô nhập liệu bên trên để bắt đầu
                            chọn.
                        </div>
                        }

                        <!-- Breadcrumb Navigation -->
                        <nav class="json-breadcrumb mb-2" aria-label="JSON Path">
                            <ol class="breadcrumb mb-0 small">
                                @for (crumb of getBreadcrumb(); track crumb.index) {
                                <li class="breadcrumb-item" [class.active]="crumb.index === currentJsonPath.length - 1">
                                    @if (crumb.index < currentJsonPath.length - 1 || crumb.index === -1) {
                                    <a href="javascript:void(0)" (click)="navigateToLevel(crumb.index)">{{ crumb.label }}</a>
                                    } @else {
                                    {{ crumb.label }}
                                    }
                                </li>
                                }
                            </ol>
                        </nav>

                        <div class="json-tree">
                            @for (item of getNodeKeys(); track item.key) {
                            <div class="json-item d-flex align-items-center">
                                <!-- Expand/Navigate button for nested objects/arrays -->
                                @if (item.expandable) {
                                <button type="button" class="btn btn-sm btn-link p-0 me-1" 
                                    (click)="selectJsonPath(item.key, false)" title="Đi vào">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                                } @else {
                                <span class="me-3"></span>
                                }

                                <!-- Key name - click to navigate if expandable -->
                                <span class="json-key" [class.cursor-pointer]="item.expandable" 
                                    (click)="item.expandable ? selectJsonPath(item.key, false) : null">
                                    {{ item.key }}
                                </span>

                                <!-- Type badge -->
                                <span class="json-type badge text-bg-light border text-secondary ms-2"
                                    style="font-size: 0.7em;">
                                    {{ item.type }}
                                    @if (item.type === 'array') {
                                    <span class="ms-1">[{{ item.value.length }}]</span>
                                    }
                                </span>

                                <!-- Value preview -->
                                <span class="json-value text-muted ms-2 text-truncate flex-grow-1"
                                    style="max-width: 300px;">
                                    {{ item.preview }}
                                </span>

                                <!-- Select button - always visible when activePathField is set -->
                                @if (activePathField) {
                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                                    (click)="selectJsonPath(item.key, true)" title="Chọn path này">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                }
                            </div>
                            }
                        </div>

                        <!-- Preview selected path output -->
                        @if (lastPreviewPath) {
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Preview: <code>{{ lastPreviewPath }}</code></small>
                            </div>
                            @if (lastPreviewError) {
                            <div class="alert alert-danger py-2 mb-0">
                                <i class="bi bi-exclamation-triangle me-1"></i>{{ lastPreviewError }}
                            </div>
                            } @else {
                            <pre class="preview-box mb-0">{{ lastPreviewValue | json }}</pre>
                            }
                        </div>
                        }
                        }

                        <!-- TAB 3: PREVIEW RESULT -->
                        @if (activeJsonTab === 'preview' && externalProducts.length > 0) {
                        <div class="table-responsive" style="max-height: 400px">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-center">Stock</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (p of externalProducts; track p.id) {
                                    <tr>
                                        <td><code>{{ p.id }}</code></td>
                                        <td>{{ p.name }}</td>
                                        <td class="text-end">{{ p.price | number }}</td>
                                        <td class="text-center">{{ p.stock }}</td>
                                    </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        }

                        <!-- TAB 4: RAW JSON -->
                        @if (activeJsonTab === 'raw' && rawResponse) {
                        <textarea class="form-control font-monospace raw-json-textarea" rows="15"
                            readonly>{{ rawResponse }}</textarea>
                        }
                    </div>
                </div>
                }
                }

                <!-- Order Tab -->
                @if (activeTab === 'order') {
                <div class="config-section">
                    <div class="section-header">
                        <i class="bi bi-cart-plus"></i>
                        <span>Order API</span>
                    </div>
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Biến có thể dùng:</strong> productId, slug, quantity (đặt trong $&#123;...&#125;)
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Method</label>
                            <select class="form-select" formControlName="orderMethod">
                                <option value="POST">POST</option>
                                <option value="GET">GET</option>
                            </select>
                        </div>
                        <div class="col-md-9">
                            <label class="form-label">Path</label>
                            <input type="text" class="form-control" formControlName="orderPath"
                                placeholder="/api/order">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Body/Query Template</label>
                            <textarea class="form-control font-monospace" formControlName="orderBodyTemplate" rows="3"
                                placeholder='{"pid": ${productId}, "quantity": ${quantity}}'></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Path <small class="text-muted">(kết quả
                                    order)</small></label>
                            <div class="input-group">
                                <input type="text" class="form-control" formControlName="orderDataPath"
                                    placeholder="data">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="startPathSelection('orderDataPath')" [disabled]="!sampleItem">
                                    <i class="bi bi-crosshair"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Success Check Path</label>
                            <div class="input-group">
                                <input type="text" class="form-control" formControlName="orderSuccessPath"
                                    placeholder="code">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="startPathSelection('orderSuccessPath')" [disabled]="!sampleItem">
                                    <i class="bi bi-crosshair"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Success Value</label>
                            <input type="text" class="form-control" formControlName="orderSuccessValue"
                                placeholder="200">
                        </div>
                    </div>

                    <!-- Test Order API Section -->
                    <div class="config-section mt-3">
                        <div class="section-header">
                            <i class="bi bi-play-circle"></i>
                            <span>Test & JSON Mapping</span>
                        </div>

                        <!-- Sub Tabs Navigation -->
                        <ul class="nav nav-tabs nav-tabs-sm mb-3">
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="activeJsonTab === 'input'"
                                    (click)="setJsonTab('input')">
                                    <i class="bi bi-keyboard me-1"></i>Input & Test
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="activeJsonTab === 'fields'"
                                    (click)="setJsonTab('fields')" [class.disabled]="!sampleItem">
                                    <i class="bi bi-braces me-1"></i>Chọn Fields
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="activeJsonTab === 'raw'" (click)="setJsonTab('raw')"
                                    [class.disabled]="!rawResponse">
                                    <i class="bi bi-code me-1"></i>Raw JSON
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content border rounded p-3">
                            <!-- TAB 1: INPUT & TEST -->
                            @if (activeJsonTab === 'input') {
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Test Order:</strong> Không nên test đặt hàng thật vì sẽ tốn tiền. Hãy paste JSON
                                response mẫu.
                            </div>

                            <div class="d-flex gap-2 mb-3">
                                @if (!isCreateMode) {
                                <button type="button" class="btn btn-outline-danger" (click)="testOrderApi()"
                                    [disabled]="loading">
                                    <i class="bi bi-play-circle me-1"></i> Test Order API ⚠️
                                </button>
                                }
                            </div>

                            <div class="bg-light p-3 rounded">
                                <label class="form-label small fw-bold">Paste JSON Response Mẫu:</label>
                                <textarea class="form-control font-monospace mb-2" rows="6" [(ngModel)]="pasteJsonText"
                                    [ngModelOptions]="{standalone: true}"
                                    placeholder='{"code": 200, "data": {...}}'></textarea>
                                <button type="button" class="btn btn-sm btn-primary" (click)="parseJsonInput()">
                                    <i class="bi bi-check me-1"></i> Parse JSON
                                </button>
                            </div>
                            }

                            <!-- TAB 2: PICK FIELDS -->
                            @if (activeJsonTab === 'fields' && sampleItem) {
                            @if (activePathField) {
                            <div class="alert alert-info py-2 mb-2">
                                <i class="bi bi-crosshair me-1"></i>
                                Đang chọn cho trường: <strong>{{ activePathField }}</strong>
                                <span class="text-muted ms-2">- Click <i class="bi bi-check-circle"></i> để chọn path, hoặc click vào tên field để đi sâu vào</span>
                            </div>
                            } @else {
                            <div class="alert alert-warning py-2 mb-2">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                Vui lòng click vào nút <i class="bi bi-crosshair"></i> ở các ô nhập liệu bên trên để bắt
                                đầu chọn.
                            </div>
                            }

                            <!-- Breadcrumb Navigation -->
                            <nav class="json-breadcrumb mb-2" aria-label="JSON Path">
                                <ol class="breadcrumb mb-0 small">
                                    @for (crumb of getBreadcrumb(); track crumb.index) {
                                    <li class="breadcrumb-item" [class.active]="crumb.index === currentJsonPath.length - 1">
                                        @if (crumb.index < currentJsonPath.length - 1 || crumb.index === -1) {
                                        <a href="javascript:void(0)" (click)="navigateToLevel(crumb.index)">{{ crumb.label }}</a>
                                        } @else {
                                        {{ crumb.label }}
                                        }
                                    </li>
                                    }
                                </ol>
                            </nav>

                            <div class="json-tree">
                                @for (item of getNodeKeys(); track item.key) {
                                <div class="json-item d-flex align-items-center">
                                    <!-- Expand/Navigate button for nested objects/arrays -->
                                    @if (item.expandable) {
                                    <button type="button" class="btn btn-sm btn-link p-0 me-1" 
                                        (click)="selectJsonPath(item.key, false)" title="Đi vào">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    } @else {
                                    <span class="me-3"></span>
                                    }

                                    <!-- Key name - click to navigate if expandable -->
                                    <span class="json-key" [class.cursor-pointer]="item.expandable" 
                                        (click)="item.expandable ? selectJsonPath(item.key, false) : null">
                                        {{ item.key }}
                                    </span>

                                    <!-- Type badge -->
                                    <span class="json-type badge text-bg-light border text-secondary ms-2"
                                        style="font-size: 0.7em;">
                                        {{ item.type }}
                                        @if (item.type === 'array') {
                                        <span class="ms-1">[{{ item.value.length }}]</span>
                                        }
                                    </span>

                                    <!-- Value preview -->
                                    <span class="json-value text-muted ms-2 text-truncate flex-grow-1"
                                        style="max-width: 300px;">
                                        {{ item.preview }}
                                    </span>

                                    <!-- Select button - always visible when activePathField is set -->
                                    @if (activePathField) {
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                                        (click)="selectJsonPath(item.key, true)" title="Chọn path này">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    }
                                </div>
                                }
                            </div>

                            <!-- Preview selected path output -->
                            @if (lastPreviewPath) {
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Preview: <code>{{ lastPreviewPath }}</code></small>
                                </div>
                                @if (lastPreviewError) {
                                <div class="alert alert-danger py-2 mb-0">
                                    <i class="bi bi-exclamation-triangle me-1"></i>{{ lastPreviewError }}
                                </div>
                                } @else {
                                <pre class="preview-box mb-0">{{ lastPreviewValue | json }}</pre>
                                }
                            </div>
                            }
                            }

                            <!-- TAB 3: RAW JSON -->
                            @if (activeJsonTab === 'raw' && rawResponse) {
                            <textarea class="form-control font-monospace raw-json-textarea" rows="15"
                                readonly>{{ rawResponse }}</textarea>
                            }
                        </div>
                    </div>
                </div>
                }

                <!-- Balance Tab -->
                @if (activeTab === 'balance') {
                <div class="config-section">
                    <div class="section-header">
                        <i class="bi bi-wallet2"></i>
                        <span>Balance API</span>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Path</label>
                            <input type="text" class="form-control" formControlName="balancePath"
                                placeholder="/api/balance">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Value Path</label>
                            <div class="input-group">
                                <input type="text" class="form-control" formControlName="balanceValuePath"
                                    placeholder="data.balance">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="startPathSelection('balanceValuePath')" [disabled]="!sampleItem">
                                    <i class="bi bi-crosshair"></i>
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- Test Balance API Section -->
                    <div class="config-section mt-3">
                        <div class="section-header">
                            <i class="bi bi-play-circle"></i>
                            <span>Test & JSON Mapping</span>
                        </div>

                        <!-- Sub Tabs Navigation -->
                        <ul class="nav nav-tabs nav-tabs-sm mb-3">
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="activeJsonTab === 'input'"
                                    (click)="setJsonTab('input')">
                                    <i class="bi bi-keyboard me-1"></i>Input & Test
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="activeJsonTab === 'fields'"
                                    (click)="setJsonTab('fields')" [class.disabled]="!sampleItem">
                                    <i class="bi bi-braces me-1"></i>Chọn Fields
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" [class.active]="activeJsonTab === 'raw'" (click)="setJsonTab('raw')"
                                    [class.disabled]="!rawResponse">
                                    <i class="bi bi-code me-1"></i>Raw JSON
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content border rounded p-3">
                            <!-- TAB 1: INPUT & TEST -->
                            @if (activeJsonTab === 'input') {
                            <div class="d-flex gap-2 mb-3">
                                @if (!isCreateMode) {
                                <button type="button" class="btn btn-outline-success" (click)="testBalanceApi()"
                                    [disabled]="loading">
                                    <i class="bi bi-play-circle me-1"></i> Test Balance API
                                </button>
                                }
                            </div>

                            <div class="bg-light p-3 rounded">
                                <label class="form-label small fw-bold">Paste JSON Response Mẫu:</label>
                                <textarea class="form-control font-monospace mb-2" rows="6" [(ngModel)]="pasteJsonText"
                                    [ngModelOptions]="{standalone: true}"
                                    placeholder='{"code": 200, "data": {"balance": 1000}}'></textarea>
                                <button type="button" class="btn btn-sm btn-primary" (click)="parseJsonInput()">
                                    <i class="bi bi-check me-1"></i> Parse JSON
                                </button>
                            </div>
                            }

                            <!-- TAB 2: PICK FIELDS -->
                            @if (activeJsonTab === 'fields' && sampleItem) {
                            @if (activePathField) {
                            <div class="alert alert-info py-2 mb-2">
                                <i class="bi bi-crosshair me-1"></i>
                                Đang chọn cho trường: <strong>{{ activePathField }}</strong>
                                <span class="text-muted ms-2">- Click <i class="bi bi-check-circle"></i> để chọn path, hoặc click vào tên field để đi sâu vào</span>
                            </div>
                            } @else {
                            <div class="alert alert-warning py-2 mb-2">
                                <i class="bi bi-exclamation-circle me-1"></i>
                                Vui lòng click vào nút <i class="bi bi-crosshair"></i> ở các ô nhập liệu bên
                                trên để bắt đầu chọn.
                            </div>
                            }

                            <!-- Breadcrumb Navigation -->
                            <nav class="json-breadcrumb mb-2" aria-label="JSON Path">
                                <ol class="breadcrumb mb-0 small">
                                    @for (crumb of getBreadcrumb(); track crumb.index) {
                                    <li class="breadcrumb-item" [class.active]="crumb.index === currentJsonPath.length - 1">
                                        @if (crumb.index < currentJsonPath.length - 1 || crumb.index === -1) {
                                        <a href="javascript:void(0)" (click)="navigateToLevel(crumb.index)">{{ crumb.label }}</a>
                                        } @else {
                                        {{ crumb.label }}
                                        }
                                    </li>
                                    }
                                </ol>
                            </nav>

                            <div class="json-tree">
                                @for (item of getNodeKeys(); track item.key) {
                                <div class="json-item d-flex align-items-center">
                                    <!-- Expand/Navigate button for nested objects/arrays -->
                                    @if (item.expandable) {
                                    <button type="button" class="btn btn-sm btn-link p-0 me-1" 
                                        (click)="selectJsonPath(item.key, false)" title="Đi vào">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                    } @else {
                                    <span class="me-3"></span>
                                    }

                                    <!-- Key name - click to navigate if expandable -->
                                    <span class="json-key" [class.cursor-pointer]="item.expandable" 
                                        (click)="item.expandable ? selectJsonPath(item.key, false) : null">
                                        {{ item.key }}
                                    </span>

                                    <!-- Type badge -->
                                    <span class="json-type badge text-bg-light border text-secondary ms-2"
                                        style="font-size: 0.7em;">
                                        {{ item.type }}
                                        @if (item.type === 'array') {
                                        <span class="ms-1">[{{ item.value.length }}]</span>
                                        }
                                    </span>

                                    <!-- Value preview -->
                                    <span class="json-value text-muted ms-2 text-truncate flex-grow-1"
                                        style="max-width: 300px;">
                                        {{ item.preview }}
                                    </span>

                                    <!-- Select button - always visible when activePathField is set -->
                                    @if (activePathField) {
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" 
                                        (click)="selectJsonPath(item.key, true)" title="Chọn path này">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    }
                                </div>
                                }
                            </div>
                            }

                            <!-- TAB 3: RAW JSON -->
                            @if (activeJsonTab === 'raw' && rawResponse) {
                            <textarea class="form-control font-monospace raw-json-textarea" rows="15"
                                readonly>{{ rawResponse }}</textarea>
                            }
                        </div>
                    </div>
                </div>
                }
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="onClose()">Hủy</button>
            <button type="button" class="btn btn-primary" (click)="onSubmit()" [disabled]="loading">
                @if (loading) {
                <span class="spinner-border spinner-border-sm me-1"></span>
                }
                {{ isCreateMode ? 'Tạo mới' : 'Cập nhật' }}
            </button>
        </div>
    </div>
</div>