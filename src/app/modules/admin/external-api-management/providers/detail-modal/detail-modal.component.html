<div class="modal-backdrop" (click)="onClose()"></div>
<div class="modal-container">
    <div class="modal-content large">
        <div class="modal-header">
            <h5 class="modal-title">
                <i class="fas fa-plug me-2"></i>
                {{ isCreateMode ? 'Thêm Provider Mới' : 'Chỉnh Sửa Provider' }}
            </h5>
            <button type="button" class="btn-close" (click)="onClose()"></button>
        </div>

        <div class="modal-body">
            <!-- Quick Templates -->
            <div class="template-buttons mb-3">
                <span class="text-muted me-2">Templates:</span>
                <button type="button" class="btn btn-sm btn-outline-primary" (click)="use777MailTemplate()">
                    777mail.vip
                </button>
                <button type="button" class="btn btn-sm btn-outline-info ms-2" (click)="useMail30sTemplate()">
                    mail30s.com
                </button>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'basic'" (click)="onTabChange('basic')">
                        <i class="bi bi-gear"></i> Cơ bản
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'product'" (click)="onTabChange('product')">
                        <i class="bi bi-box"></i> Product API
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'order'" (click)="onTabChange('order')">
                        <i class="bi bi-cart"></i> Order API
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" [class.active]="activeTab === 'balance'" (click)="onTabChange('balance')">
                        <i class="bi bi-wallet2"></i> Balance & Sync
                    </a>
                </li>
            </ul>

            <form [formGroup]="form">
                <!-- Basic Tab -->
                @if (activeTab === 'basic') {
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Tên Provider <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" formControlName="name" placeholder="Ví dụ: 777mail.vip">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Base URL <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" formControlName="baseUrl"
                            placeholder="https://777mail.vip">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-control" formControlName="apiKey"
                            placeholder="API Key từ provider">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Kiểu xác thực</label>
                        <select class="form-select" formControlName="authType">
                            <option value="HEADER">Header (Authorization)</option>
                            <option value="QUERY_PARAM">Query Param (?api_key=xxx)</option>
                        </select>
                    </div>
                    @if (form.get('authType')?.value === 'HEADER') {
                    <div class="col-md-6">
                        <label class="form-label">Tên Header</label>
                        <input type="text" class="form-control" formControlName="authHeaderName"
                            placeholder="Authorization">
                    </div>
                    }
                    @if (form.get('authType')?.value === 'QUERY_PARAM') {
                    <div class="col-md-6">
                        <label class="form-label">Tên Query Param</label>
                        <input type="text" class="form-control" formControlName="authQueryParam" placeholder="api_key">
                    </div>
                    }
                    <div class="col-md-6">
                        <label class="form-label">Trạng thái</label>
                        <select class="form-select" formControlName="status">
                            <option [value]="1">Hoạt động</option>
                            <option [value]="0">Ngưng</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" formControlName="notes" rows="2"></textarea>
                    </div>
                </div>
                }

                <!-- Product Tab -->
                @if (activeTab === 'product') {
                <div class="row g-3">
                    <div class="col-12">
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle"></i>
                            Cấu hình API lấy danh sách sản phẩm từ nguồn. Dùng JSONPath để chỉ định vị trí dữ liệu.
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Method</label>
                        <select class="form-select" formControlName="productListMethod">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Path</label>
                        <input type="text" class="form-control" formControlName="productListPath"
                            placeholder="/api/v1/products">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Data Path (JSONPath)</label>
                        <input type="text" class="form-control" formControlName="productListDataPath"
                            placeholder="$.data">
                    </div>
                    <hr class="my-3">
                    <h6 class="mb-3">Field Mappings:</h6>
                    <div class="col-md-4">
                        <label class="form-label">ID Path</label>
                        <input type="text" class="form-control" formControlName="productIdPath" placeholder="$.id">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Name Path</label>
                        <input type="text" class="form-control" formControlName="productNamePath" placeholder="$.name">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Price Path</label>
                        <input type="text" class="form-control" formControlName="productPricePath"
                            placeholder="$.price">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Stock Path</label>
                        <input type="text" class="form-control" formControlName="productStockPath"
                            placeholder="$.stock">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Slug Path (optional)</label>
                        <input type="text" class="form-control" formControlName="productSlugPath" placeholder="$.slug">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Description Path</label>
                        <input type="text" class="form-control" formControlName="productDescriptionPath"
                            placeholder="$.description">
                    </div>
                </div>

                <!-- Test Fetch Products -->
                @if (!isCreateMode) {
                <div class="mt-4">
                    <button type="button" class="btn btn-outline-primary" (click)="onFetchProducts()"
                        [disabled]="loadingProducts">
                        @if (loadingProducts) {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-download me-1"></i> Test Fetch Products
                    </button>
                    @if (externalProducts.length > 0) {
                    <div class="mt-3">
                        <h6>Kết quả ({{externalProducts.length}} sản phẩm):</h6>
                        <div class="table-responsive" style="max-height: 200px">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Price</th>
                                        <th>Stock</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (p of externalProducts; track p.id) {
                                    <tr>
                                        <td>{{p.id}}</td>
                                        <td>{{p.name}}</td>
                                        <td>{{p.price | number}}</td>
                                        <td>{{p.stock}}</td>
                                    </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    }
                </div>
                }
                }

                <!-- Order Tab -->
                @if (activeTab === 'order') {
                <div class="row g-3">
                    <div class="col-12">
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            Cấu hình API đặt hàng. Placeholders: ${{ '{' }}productId{{ '}' }}, ${{ '{' }}slug{{ '}' }},
                            ${{ '{' }}quantity{{ '}' }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Method</label>
                        <select class="form-select" formControlName="orderMethod">
                            <option value="POST">POST</option>
                            <option value="GET">GET</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Path</label>
                        <input type="text" class="form-control" formControlName="orderPath" placeholder="/api/v1/order">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Body/Query Template</label>
                        <textarea class="form-control" formControlName="orderBodyTemplate" rows="3"></textarea>
                        <small class="text-muted">
                            POST: JSON body, GET: query params. Use ${{ '{' }}productId{{ '}' }}, ${{ '{' }}slug{{ '}'
                            }}, ${{ '{' }}quantity{{ '}' }}
                        </small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Data Path (account data)</label>
                        <input type="text" class="form-control" formControlName="orderDataPath" placeholder="$.data">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Success Check Path</label>
                        <input type="text" class="form-control" formControlName="orderSuccessPath" placeholder="$.code">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Success Value</label>
                        <input type="text" class="form-control" formControlName="orderSuccessValue" placeholder="200">
                    </div>
                </div>
                }

                <!-- Balance Tab -->
                @if (activeTab === 'balance') {
                <div class="row g-3">
                    <h6 class="mb-2">Balance API</h6>
                    <div class="col-md-8">
                        <label class="form-label">Path</label>
                        <input type="text" class="form-control" formControlName="balancePath"
                            placeholder="/api/v1/balance">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Value Path</label>
                        <input type="text" class="form-control" formControlName="balanceValuePath" placeholder="$.data">
                    </div>
                    <hr class="my-3">
                    <h6 class="mb-2">Auto Sync</h6>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" formControlName="autoSyncEnabled"
                                id="autoSyncEnabled">
                            <label class="form-check-label" for="autoSyncEnabled">Bật tự động sync stock</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Interval (giây)</label>
                        <input type="number" class="form-control" formControlName="syncIntervalSeconds" min="60">
                    </div>

                    <!-- Test Connection -->
                    @if (!isCreateMode) {
                    <div class="col-12 mt-3">
                        <button type="button" class="btn btn-outline-success" (click)="onTestConnection()">
                            <i class="bi bi-plug me-1"></i> Test Connection
                        </button>
                        @if (testResult) {
                        <div class="alert mt-2" [class.alert-success]="testResult.success"
                            [class.alert-danger]="!testResult.success">
                            <strong>{{ testResult.success ? 'Thành công!' : 'Thất bại!' }}</strong>
                            {{ testResult.message }}
                            @if (testResult.balance) {
                            <br>Balance: <strong>{{ testResult.balance }}</strong>
                            }
                        </div>
                        }
                    </div>
                    }
                </div>
                }
            </form>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="onClose()">Hủy</button>
            <button type="button" class="btn btn-primary" (click)="onSubmit()" [disabled]="loading">
                @if (loading) {
                <span class="spinner-border spinner-border-sm me-1"></span>
                }
                {{ isCreateMode ? 'Tạo mới' : 'Cập nhật' }}
            </button>
        </div>
    </div>
</div>