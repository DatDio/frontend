<div class="transactions-management">

  <!-- Web2m QR Modal -->
  @if (showQrModal) {
  <div class="qr-modal-overlay" (click)="closeQrModal()">
    <div class="qr-modal-content" (click)="$event.stopPropagation()">
      <div class="qr-modal-header">
        <h3><i class="bi bi-qr-code me-2"></i>{{ 'TRANSACTION.QR_TITLE' | translate }}</h3>
        <button class="qr-close-btn" (click)="closeQrModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="qr-modal-body">
        <!-- QR Code Image -->
        <div class="qr-code-container">
          <img [src]="qrCodeUrl" alt="QR Code" class="qr-code-image">
        </div>

        <!-- Bank Info -->
        <div class="bank-info">
          <div class="bank-info-row">
            <span class="label">{{ 'TRANSACTION.BANK' | translate }}:</span>
            <span class="value">{{ bankName }}</span>
          </div>
          <div class="bank-info-row">
            <span class="label">{{ 'TRANSACTION.ACCOUNT_NUMBER' | translate }}:</span>
            <span class="value">
              {{ accountNumber }}
              <button class="copy-btn" (click)="copyAccountNumber()" title="{{ 'COMMON.COPY' | translate }}">
                <i class="bi bi-clipboard"></i>
              </button>
            </span>
          </div>
          <div class="bank-info-row">
            <span class="label">{{ 'TRANSACTION.ACCOUNT_NAME' | translate }}:</span>
            <span class="value">{{ accountName }}</span>
          </div>
          <div class="bank-info-row">
            <span class="label">{{ 'TRANSACTION.AMOUNT' | translate }}:</span>
            <span class="value amount">{{ depositAmount | vndUsd }}</span>
          </div>
          <div class="bank-info-row content-row">
            <span class="label">{{ 'TRANSACTION.CONTENT' | translate }}:</span>
            <span class="value transfer-content">
              {{ transferContent }}
              <button class="copy-btn" (click)="copyTransferContent()" title="{{ 'COMMON.COPY' | translate }}">
                <i class="bi bi-clipboard"></i>
              </button>
            </span>
          </div>
        </div>

        <div class="qr-note">
          <i class="bi bi-info-circle me-1"></i>
          <span>{{ 'TRANSACTION.QR_NOTE' | translate }}</span>
        </div>

        <!-- Waiting State -->
        <div class="qr-waiting-state">
          <div class="waiting-spinner">
            <span class="spinner-border spinner-border-sm me-2"></span>
            <span>{{ 'TRANSACTION.WAITING' | translate }}</span>
          </div>
          <p class="waiting-note">{{ 'TRANSACTION.AUTO_UPDATE' | translate }}</p>
        </div>

        <button class="qr-close-btn" (click)="closeQrModal()">
          <i class="bi bi-x-lg me-2"></i>{{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Crypto Payment Modal -->
  @if (showCryptoModal) {
  <div class="qr-modal-overlay" (click)="closeCryptoModal()">
    <div class="qr-modal-content crypto-modal" (click)="$event.stopPropagation()">
      <div class="qr-modal-header crypto-header">
        <h3><i class="bi bi-currency-bitcoin me-2"></i>{{ 'TRANSACTION.CRYPTO_TITLE' | translate }}</h3>
        <button class="qr-close-btn" (click)="closeCryptoModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="qr-modal-body">
        <div class="crypto-info">
          <div class="crypto-icon-large">
            <i class="bi bi-currency-bitcoin"></i>
          </div>
          <h4>{{ 'TRANSACTION.PAYMENT_CREATED' | translate }}</h4>
          <p class="crypto-trans-id">{{ 'TRANSACTION.TRANS_ID' | translate }}: <strong>{{ cryptoTransId }}</strong></p>
        </div>

        <div class="bank-info crypto-payment-info">
          <div class="bank-info-row">
            <span class="label">{{ 'TRANSACTION.USDT_AMOUNT_LABEL' | translate }}:</span>
            <span class="value crypto-value">{{ cryptoAmount }} USDT</span>
          </div>
          <div class="bank-info-row">
            <span class="label">{{ 'TRANSACTION.EQUIVALENT_VND' | translate }}:</span>
            <span class="value amount">{{ estimatedVnd | vndUsd }}</span>
          </div>
        </div>

        <div class="crypto-action-section">
          <button class="deposit-btn crypto-btn" (click)="openCryptoPayment()">
            <i class="bi bi-box-arrow-up-right me-2"></i>
            {{ 'TRANSACTION.OPEN_PAYMENT' | translate }}
          </button>
        </div>

        <div class="qr-note crypto-note">
          <i class="bi bi-info-circle me-1"></i>
          <span>{{ 'TRANSACTION.CRYPTO_CONFIRM_NOTE' | translate }}</span>
        </div>

        <!-- Waiting State -->
        <div class="qr-waiting-state">
          <div class="waiting-spinner">
            <span class="spinner-border spinner-border-sm me-2"></span>
            <span>{{ 'TRANSACTION.WAITING' | translate }}</span>
          </div>
          <p class="waiting-note">{{ 'TRANSACTION.AUTO_UPDATE' | translate }}</p>
        </div>

        <button class="btn btn-secondary mt-3" (click)="closeCryptoModal()">
          <i class="bi bi-x-lg me-2"></i>{{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Note Modal -->
  @if (showNoteModal && selectedTransaction) {
  <div class="note-modal-overlay" (click)="closeNoteModal()">
    <div class="note-modal-content" (click)="$event.stopPropagation()">
      <div class="note-modal-header">
        <h4><i class="bi bi-file-text me-2"></i>{{ 'TRANSACTION.DETAIL' | translate }}</h4>
        <button class="note-close-btn" (click)="closeNoteModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
      <div class="note-modal-body">
        <div class="note-info-row">
          <span class="note-label">{{ 'TRANSACTION.CODE' | translate }}:</span>
          <span class="note-value">{{ selectedTransaction.transactionCode }}</span>
        </div>
        <div class="note-info-row">
          <span class="note-label">{{ 'TRANSACTION.TYPE' | translate }}:</span>
          <span class="badge" [ngClass]="getTypeClass(selectedTransaction.type)">
            {{ ('WALLET.' + selectedTransaction.type) | translate }}
          </span>
        </div>
        <div class="note-info-row">
          <span class="note-label">{{ 'TRANSACTION.STATUS' | translate }}:</span>
          <span class="badge" [ngClass]="getStatusClass(selectedTransaction.status)">
            {{ ('TRANSACTION.' + selectedTransaction.status) | translate }}
          </span>
        </div>
        @if (selectedTransaction.description) {
        <div class="note-section">
          <span class="note-section-title"><i class="bi bi-chat-left-text me-1"></i>{{ 'TRANSACTION.DESCRIPTION' |
            translate }}:</span>
          <p class="note-content">{{ selectedTransaction.description }}</p>
        </div>
        }
        @if (selectedTransaction.status === 'FAILED' && selectedTransaction.errorMessage) {
        <div class="note-section error-section">
          <span class="note-section-title"><i class="bi bi-exclamation-triangle me-1"></i>{{
            'TRANSACTION.FAILURE_REASON' | translate }}:</span>
          <p class="note-content">{{ selectedTransaction.errorMessage }}</p>
        </div>
        }
      </div>
      <div class="note-modal-footer">
        <button class="btn btn-secondary" (click)="closeNoteModal()">
          <i class="bi bi-x me-1"></i>{{ 'COMMON.CLOSE' | translate }}
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Premium Deposit Card -->
  <div class="deposit-section mb-5">
    <div class="deposit-card">
      <!-- Header -->
      <div class="deposit-header">
        <div class="deposit-icon">
          <i class="bi bi-wallet2"></i>
        </div>
        <h3>{{ 'TRANSACTION.DEPOSIT_TITLE' | translate }}</h3>
        <p class="deposit-subtitle">{{ 'TRANSACTION.DEPOSIT_SUBTITLE' | translate }}</p>
      </div>

      <!-- Rank Info Badge -->
      @if (userRankInfo) {
      <div class="rank-info-section">
        <div class="rank-badge">
          @if (userRankInfo.iconUrl) {
          <img [src]="userRankInfo.iconUrl" alt="Rank Icon" class="rank-icon">
          } @else {
          <i class="bi bi-trophy-fill"></i>
          }
          <div class="rank-details">
            <span class="rank-label">{{ 'TRANSACTION.CURRENT_RANK' | translate }}</span>
            <span class="rank-name">{{ userRankInfo.rankName }}</span>
          </div>
          <div class="bonus-badge">
            <span class="bonus-percent">+{{ userRankInfo.bonusPercent }}%</span>
            <span class="bonus-label">Rank</span>
          </div>
          @if (isCollaborator && ctvBonusPercent > 0) {
          <div class="bonus-badge ctv-badge">
            <span class="bonus-percent">+{{ ctvBonusPercent }}%</span>
            <span class="bonus-label">CTV</span>
          </div>
          }
        </div>

        <!-- Progress to next rank -->
        @if (userRankInfo.nextRankName) {
        <div class="next-rank-progress">
          <div class="progress-info">
            <span>{{ 'TRANSACTION.NEXT_RANK_PROGRESS' | translate }} <strong>{{ userRankInfo.nextRankName
                }}</strong></span>
            <span>{{ userRankInfo.currentDeposit | number:'1.0-0' }} / {{ userRankInfo.nextRankMinDeposit |
              number:'1.0-0' }} VNĐ</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill"
              [style.width.%]="(userRankInfo.currentDeposit / (userRankInfo.nextRankMinDeposit || 1)) * 100"></div>
          </div>
        </div>
        }
      </div>
      }

      <!-- Deposit Method Tabs -->
      <div class="deposit-method-tabs">
        <button class="method-tab" [class.active]="depositMethod === 'vietqr'" (click)="depositMethod = 'vietqr'">
          <i class="bi bi-qr-code me-2"></i>
          {{ 'TRANSACTION.METHOD_VIETQR' | translate }}
        </button>
        <button class="method-tab" [class.active]="depositMethod === 'crypto'" (click)="depositMethod = 'crypto'">
          <i class="bi bi-currency-bitcoin me-2"></i>
          {{ 'TRANSACTION.METHOD_CRYPTO' | translate }}
        </button>
      </div>

      <!-- VietQR Deposit Form -->
      @if (depositMethod === 'vietqr') {
      <div class="deposit-form">
        <label class="input-label">{{ 'TRANSACTION.DEPOSIT_AMOUNT' | translate }}</label>
        <div class="amount-input-wrapper">
          <input type="text" class="amount-input" [value]="depositAmountDisplay" (input)="onDepositAmountChange($event)"
            [placeholder]="'TRANSACTION.ENTER_AMOUNT' | translate">
          <span class="currency-tag">VNĐ</span>
        </div>

        <!-- Quick Amount Buttons -->
        <div class="quick-amounts">
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 50000; depositAmountDisplay = '50,000'">50K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 100000; depositAmountDisplay = '100,000'">100K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 200000; depositAmountDisplay = '200,000'">200K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 500000; depositAmountDisplay = '500,000'">500K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 1000000; depositAmountDisplay = '1,000,000'">1M</button>
        </div>

        <!-- Bonus Preview -->
        @if (getTotalBonusPercent() > 0) {
        <div class="bonus-preview">
          <div class="bonus-row">
            <span>{{ 'TRANSACTION.DEPOSIT_AMOUNT' | translate }}:</span>
            <span>{{ depositAmount | number:'1.0-0' }} VNĐ</span>
          </div>
          @if (userRankInfo && userRankInfo.bonusPercent > 0) {
          <div class="bonus-row">
            <span><i class="bi bi-trophy me-1"></i>Bonus Rank ({{ userRankInfo.bonusPercent }}%):</span>
            <span class="bonus-value">+{{ (depositAmount * userRankInfo.bonusPercent / 100) | number:'1.0-0' }}
              VNĐ</span>
          </div>
          }
          @if (isCollaborator && ctvBonusPercent > 0) {
          <div class="bonus-row">
            <span><i class="bi bi-person-badge me-1"></i>Bonus CTV ({{ ctvBonusPercent }}%):</span>
            <span class="bonus-value">+{{ (depositAmount * ctvBonusPercent / 100) | number:'1.0-0' }} VNĐ</span>
          </div>
          }
          <div class="bonus-row highlight">
            <span><i class="bi bi-gift-fill me-1"></i>Tổng bonus ({{ getTotalBonusPercent() }}%):</span>
            <span class="bonus-value">+{{ calculateBonus() | number:'1.0-0' }} VNĐ</span>
          </div>
          <div class="bonus-row total">
            <span>{{ 'TRANSACTION.TOTAL_RECEIVED' | translate }}:</span>
            <span class="total-value">{{ calculateTotal() | number:'1.0-0' }} VNĐ</span>
          </div>
        </div>
        }

        <button class="deposit-btn" (click)="createDeposit()">
          <i class="bi bi-credit-card me-2"></i>
          {{ 'TRANSACTION.PAY_NOW' | translate }}
        </button>

        <p class="deposit-note">
          <i class="bi bi-shield-check me-1"></i>
          {{ 'TRANSACTION.SECURITY_NOTE' | translate }}
        </p>
      </div>
      }

      <!-- Crypto (USDT) Deposit Form -->
      @if (depositMethod === 'crypto') {
      <div class="deposit-form crypto-form">
        <label class="input-label">{{ 'TRANSACTION.USDT_AMOUNT' | translate }}</label>
        <div class="amount-input-wrapper">
          <input type="text" class="amount-input" [value]="cryptoAmountDisplay" (input)="onCryptoAmountChange($event)"
            [placeholder]="'TRANSACTION.USDT_PLACEHOLDER' | translate">
          <span class="currency-tag crypto-tag">USDT</span>
        </div>

        <!-- Quick USDT Amount Buttons -->
        <div class="quick-amounts">
          <button type="button" class="quick-amount-btn"
            (click)="cryptoAmount = 5; cryptoAmountDisplay = '5'; estimatedVnd = calculateEstimatedVnd()">5
            USDT</button>
          <button type="button" class="quick-amount-btn"
            (click)="cryptoAmount = 10; cryptoAmountDisplay = '10'; estimatedVnd = calculateEstimatedVnd()">10
            USDT</button>
          <button type="button" class="quick-amount-btn"
            (click)="cryptoAmount = 20; cryptoAmountDisplay = '20'; estimatedVnd = calculateEstimatedVnd()">20
            USDT</button>
          <button type="button" class="quick-amount-btn"
            (click)="cryptoAmount = 50; cryptoAmountDisplay = '50'; estimatedVnd = calculateEstimatedVnd()">50
            USDT</button>
          <button type="button" class="quick-amount-btn"
            (click)="cryptoAmount = 100; cryptoAmountDisplay = '100'; estimatedVnd = calculateEstimatedVnd()">100
            USDT</button>
        </div>

        <!-- Exchange Rate & VND Preview -->
        @if (cryptoAmount > 0) {
        <div class="crypto-preview">
          <div class="exchange-rate-info">
            <i class="bi bi-arrow-left-right me-1"></i>
            {{ 'TRANSACTION.EXCHANGE_RATE' | translate }}: 1 USDT = {{ usdVndRate | number:'1.0-0' }} VNĐ
          </div>
          <div class="bonus-preview">
            <div class="bonus-row">
              <span>{{ 'TRANSACTION.USDT_PAYMENT' | translate }}:</span>
              <span class="crypto-value">{{ cryptoAmount }} USDT</span>
            </div>
            <div class="bonus-row highlight">
              <span><i class="bi bi-cash-stack me-1"></i>{{ 'TRANSACTION.EQUIVALENT_VND' | translate }}:</span>
              <span class="vnd-value">{{ estimatedVnd | number:'1.0-0' }} VNĐ</span>
            </div>
            @if (getTotalBonusPercent() > 0) {
            <div class="bonus-row">
              <span><i class="bi bi-gift me-1"></i>{{ 'TRANSACTION.TOTAL_BONUS_PERCENT' | translate }} ({{
                getTotalBonusPercent() }}%):</span>
              <span class="bonus-value">+{{ calculateCryptoBonus() | number:'1.0-0' }} VNĐ</span>
            </div>
            <div class="bonus-row total">
              <span>{{ 'TRANSACTION.TOTAL_RECEIVED_CRYPTO' | translate }}:</span>
              <span class="total-value">{{ calculateCryptoTotal() | number:'1.0-0' }} VNĐ</span>
            </div>
            }
          </div>
        </div>
        }

        <button class="deposit-btn crypto-btn" (click)="createDepositCrypto()">
          <i class="bi bi-currency-bitcoin me-2"></i>
          {{ 'TRANSACTION.PAY_USDT' | translate }}
        </button>

        <p class="deposit-note">
          <i class="bi bi-info-circle me-1"></i>
          {{ 'TRANSACTION.CRYPTO_NOTE' | translate }}
        </p>
      </div>
      }
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ 'TRANSACTION.TITLE' | translate }}</h1>
  </div>
  <div class="card search-card mb-4">
    <div class="card-body">
      <form [formGroup]="formSearch" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">{{ 'TRANSACTION.CODE' | translate }}</label>
          <input type="text" class="form-control" [placeholder]="'TRANSACTION.ENTER_CODE' | translate"
            formControlName="transactionCode">
        </div>

        <!-- <div class="col-md-3">
          <label class="form-label">Trạng thái</label>
          <select class="form-select" formControlName="status">
            <option value="">-- Tất cả --</option>
            <option value="pending">Chờ xử lý</option>
            <option value="completed">Hoàn thành</option>
            <option value="failed">Thất bại</option>
            <option value="cancelled">Hủy</option>
          </select>
        </div> -->

        <div class="col-md-3">
          <label class="form-label">{{ 'TRANSACTION.FROM_DATE' | translate }}</label>
          <input type="date" class="form-control" formControlName="dateFrom">
        </div>

        <div class="col-md-3">
          <label class="form-label">{{ 'TRANSACTION.TO_DATE' | translate }}</label>
          <input type="date" class="form-control" formControlName="dateTo">
        </div>

        <div class="col-md-6 d-flex align-items-end gap-2 mt-4">
          <button type="button" class="btn btn-search w-50" (click)="handleSearch()">
            <i class="bi bi-search"></i> {{ 'COMMON.SEARCH' | translate }}
          </button>

          <button type="button" class="btn btn-refresh w-50" (click)="clearForm()">
            <i class="bi bi-arrow-clockwise"></i> {{ 'COMMON.RESET_FILTER' | translate }}
          </button>
        </div>

      </form>
    </div>
  </div>

  <div class="card transaction-table-card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col-md-6">
          <span class="text-muted">
            {{ 'TRANSACTION.TOTAL_TRANSACTIONS' | translate }}: {{ paginationConfig.totalElements }}
          </span>
        </div>
      </div>
    </div>

    <div class="card-body p-0">
      @if (loading) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
      </div>
      } @else {
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th style="width: 50px; text-align:center;">{{ 'TABLE.NO' | translate }}</th>
              <th>{{ 'TRANSACTION.CODE' | translate }}</th>
              <th>{{ 'TRANSACTION.TYPE' | translate }}</th>
              <th>{{ 'TRANSACTION.AMOUNT' | translate }}</th>
              <th>{{ 'TRANSACTION.STATUS' | translate }}</th>
              <th>{{ 'TRANSACTION.CREATED_AT' | translate }}</th>
              <th>{{ 'TRANSACTION.COMPLETED_AT' | translate }}</th>
              <th style="width: 80px; text-align: center;">{{ 'COMMON.ACTIONS' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (transaction of transactions; track transaction.id; let i = $index) {
            <tr>
              <td class="text-center fw-bold">
                {{ i + 1 + (paginationConfig.currentPage * paginationConfig.pageSize) }}
              </td>

              <td class="fw-semibold">
                {{ transaction.transactionCode }}
              </td>

              <td>
                <span class="badge" [ngClass]="getTypeClass(transaction.type)">
                  {{ ('WALLET.' + transaction.type) | translate }}
                </span>
              </td>

              <td class="fw-bold">
                {{ transaction.amount | vndUsd }}
              </td>

              <td>
                <span class="badge" [ngClass]="getStatusClass(transaction.status)">
                  {{ ('TRANSACTION.' + transaction.status) | translate }}
                </span>
              </td>

              <td>
                {{ transaction.createdAt | date:'dd/MM/yyyy HH:mm' }}
              </td>

              <td>
                {{ transaction.completedAt | date:'dd/MM/yyyy HH:mm' }}
              </td>

              <td class="text-center">
                @if (hasNote(transaction)) {
                <button class="btn btn-sm btn-outline-info" title="{{ 'TRANSACTION.NOTE' | translate }}"
                  (click)="openNoteModal(transaction)">
                  <i class="bi bi-eye"></i>
                </button>
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
            </tr>
            }

            @if (transactions.length === 0) {
            <tr>
              <td colspan="8" class="text-center py-4 text-muted">
                {{ 'TRANSACTION.NO_TRANSACTIONS' | translate }}
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </div>

    @if (paginationConfig.totalPages > 0) {
    <div class="card-footer">
      <app-pagination [config]="paginationConfig" (pageChange)="handlePageChange($event)"
        (pageSizeChange)="selectPageSize($event)">
      </app-pagination>
    </div>
    }
  </div>
</div>