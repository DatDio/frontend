<div class="transactions-management">

  <!-- Web2m QR Modal -->
  @if (showQrModal) {
  <div class="qr-modal-overlay" (click)="closeQrModal()">
    <div class="qr-modal-content" (click)="$event.stopPropagation()">
      <div class="qr-modal-header">
        <h3><i class="bi bi-qr-code me-2"></i>Quét mã QR để thanh toán</h3>
        <button class="qr-close-btn" (click)="closeQrModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="qr-modal-body">
        <!-- QR Code Image -->
        <div class="qr-code-container">
          <img [src]="qrCodeUrl" alt="QR Code" class="qr-code-image">
        </div>

        <!-- Bank Info -->
        <div class="bank-info">
          <div class="bank-info-row">
            <span class="label">Ngân hàng:</span>
            <span class="value">{{ bankName }}</span>
          </div>
          <div class="bank-info-row">
            <span class="label">Số tài khoản:</span>
            <span class="value">
              {{ accountNumber }}
              <button class="copy-btn" (click)="copyAccountNumber()" title="Sao chép">
                <i class="bi bi-clipboard"></i>
              </button>
            </span>
          </div>
          <div class="bank-info-row">
            <span class="label">Chủ tài khoản:</span>
            <span class="value">{{ accountName }}</span>
          </div>
          <div class="bank-info-row">
            <span class="label">Số tiền:</span>
            <span class="value amount">{{ depositAmount | number:'1.0-0' }} VNĐ</span>
          </div>
          <div class="bank-info-row content-row">
            <span class="label">Nội dung CK:</span>
            <span class="value transfer-content">
              {{ transferContent }}
              <button class="copy-btn" (click)="copyTransferContent()" title="Sao chép">
                <i class="bi bi-clipboard"></i>
              </button>
            </span>
          </div>
        </div>

        <div class="qr-note">
          <i class="bi bi-info-circle me-1"></i>
          <span>Vui lòng nhập <strong>đúng nội dung chuyển khoản</strong> để giao dịch được xử lý tự động.</span>
        </div>

        <!-- Waiting State -->
        <div class="qr-waiting-state">
          <div class="waiting-spinner">
            <span class="spinner-border spinner-border-sm me-2"></span>
            <span>Đang chờ xác nhận thanh toán...</span>
          </div>
          <p class="waiting-note">Hệ thống sẽ tự động cập nhật khi nhận được giao dịch của bạn</p>
        </div>

        <button class="qr-close-btn" (click)="closeQrModal()">
          <i class="bi bi-x-lg me-2"></i>Đóng
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Premium Deposit Card -->
  <div class="deposit-section mb-5">
    <div class="deposit-card">
      <!-- Header -->
      <div class="deposit-header">
        <div class="deposit-icon">
          <i class="bi bi-wallet2"></i>
        </div>
        <h3>Nạp tiền vào tài khoản</h3>
        <p class="deposit-subtitle">Thanh toán nhanh chóng, an toàn qua ngân hàng</p>
      </div>

      <!-- Rank Info Badge -->
      @if (userRankInfo) {
      <div class="rank-info-section">
        <div class="rank-badge">
          @if (userRankInfo.iconUrl) {
          <img [src]="userRankInfo.iconUrl" alt="Rank Icon" class="rank-icon">
          } @else {
          <i class="bi bi-trophy-fill"></i>
          }
          <div class="rank-details">
            <span class="rank-label">Hạng hiện tại</span>
            <span class="rank-name">{{ userRankInfo.rankName }}</span>
          </div>
          <div class="bonus-badge">
            <span class="bonus-percent">+{{ userRankInfo.bonusPercent }}%</span>
            <span class="bonus-label">Bonus</span>
          </div>
        </div>

        <!-- Progress to next rank -->
        @if (userRankInfo.nextRankName) {
        <div class="next-rank-progress">
          <div class="progress-info">
            <span>Tiến độ đến <strong>{{ userRankInfo.nextRankName }}</strong></span>
            <span>{{ userRankInfo.currentDeposit | number:'1.0-0' }} / {{ userRankInfo.nextRankMinDeposit |
              number:'1.0-0' }} VNĐ</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill"
              [style.width.%]="(userRankInfo.currentDeposit / (userRankInfo.nextRankMinDeposit || 1)) * 100"></div>
          </div>
        </div>
        }
      </div>
      }

      <!-- Deposit Form -->
      <div class="deposit-form">
        <label class="input-label">Số tiền nạp</label>
        <div class="amount-input-wrapper">
          <input type="text" class="amount-input" [value]="depositAmountDisplay" (input)="onDepositAmountChange($event)"
            placeholder="Nhập số tiền">
          <span class="currency-tag">VNĐ</span>
        </div>

        <!-- Quick Amount Buttons -->
        <div class="quick-amounts">
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 50000; depositAmountDisplay = '50,000'">50K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 100000; depositAmountDisplay = '100,000'">100K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 200000; depositAmountDisplay = '200,000'">200K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 500000; depositAmountDisplay = '500,000'">500K</button>
          <button type="button" class="quick-amount-btn"
            (click)="depositAmount = 1000000; depositAmountDisplay = '1,000,000'">1M</button>
        </div>

        <!-- Bonus Preview -->
        @if (userRankInfo && userRankInfo.bonusPercent > 0) {
        <div class="bonus-preview">
          <div class="bonus-row">
            <span>Số tiền nạp:</span>
            <span>{{ depositAmount | number:'1.0-0' }} VNĐ</span>
          </div>
          <div class="bonus-row highlight">
            <span><i class="bi bi-gift-fill me-1"></i>Bonus ({{ userRankInfo.bonusPercent }}%):</span>
            <span class="bonus-value">+{{ calculateBonus() | number:'1.0-0' }} VNĐ</span>
          </div>
          <div class="bonus-row total">
            <span>Tổng nhận:</span>
            <span class="total-value">{{ calculateTotal() | number:'1.0-0' }} VNĐ</span>
          </div>
        </div>
        }

        <button class="deposit-btn" (click)="createDeposit()">
          <i class="bi bi-credit-card me-2"></i>
          Thanh toán ngay
        </button>

        <p class="deposit-note">
          <i class="bi bi-shield-check me-1"></i>
          Giao dịch được bảo mật tuyệt đối
        </p>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Lịch sử giao dịch</h1>
  </div>
  <div class="card search-card mb-4">
    <div class="card-body">
      <form [formGroup]="formSearch" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Mã giao dịch</label>
          <input type="text" class="form-control" placeholder="Nhập mã giao dịch..." formControlName="transactionCode">
        </div>

        <!-- <div class="col-md-3">
          <label class="form-label">Trạng thái</label>
          <select class="form-select" formControlName="status">
            <option value="">-- Tất cả --</option>
            <option value="pending">Chờ xử lý</option>
            <option value="completed">Hoàn thành</option>
            <option value="failed">Thất bại</option>
            <option value="cancelled">Hủy</option>
          </select>
        </div> -->

        <div class="col-md-3">
          <label class="form-label">Từ ngày</label>
          <input type="date" class="form-control" formControlName="dateFrom">
        </div>

        <div class="col-md-3">
          <label class="form-label">Đến ngày</label>
          <input type="date" class="form-control" formControlName="dateTo">
        </div>

        <div class="col-md-6 d-flex align-items-end gap-2 mt-4">
          <button type="button" class="btn btn-search w-50" (click)="handleSearch()">
            <i class="bi bi-search"></i> Tìm kiếm
          </button>

          <button type="button" class="btn btn-refresh w-50" (click)="clearForm()">
            <i class="bi bi-arrow-clockwise"></i> Xóa bộ lọc
          </button>
        </div>

      </form>
    </div>
  </div>

  <div class="card transaction-table-card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col-md-6">
          <span class="text-muted">
            Tổng giao dịch: {{ paginationConfig.totalElements }}
          </span>
        </div>
      </div>
    </div>

    <div class="card-body p-0">
      @if (loading) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
      </div>
      } @else {
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th style="width: 50px; text-align:center;">#</th>
              <th>Mã GD</th>
              <th>Loại</th>
              <th>Số tiền</th>
              <th>Trạng thái</th>
              <th>Ngày tạo</th>
            </tr>
          </thead>
          <tbody>
            @for (transaction of transactions; track transaction.id; let i = $index) {
            <tr>
              <td class="text-center fw-bold">
                {{ i + 1 + (paginationConfig.currentPage * paginationConfig.pageSize) }}
              </td>

              <td class="fw-semibold">
                {{ transaction.transactionCode }}
              </td>

              <td>
                <span class="badge" [ngClass]="getTypeClass(transaction.type)">
                  {{ getTypeLabel(transaction.type) }}
                </span>
              </td>

              <td class="fw-bold">
                {{ transaction.amount | number:'1.0-0' }} VNĐ
              </td>

              <td>
                <span class="badge" [ngClass]="getStatusClass(transaction.status)">
                  {{ getStatusLabel(transaction.status) }}
                </span>
              </td>

              <td>
                {{ transaction.completedAt | date:'dd/MM/yyyy HH:mm' }}
              </td>
            </tr>
            }

            @if (transactions.length === 0) {
            <tr>
              <td colspan="6" class="text-center py-4 text-muted">
                Không có giao dịch nào
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </div>

    @if (paginationConfig.totalPages > 0) {
    <div class="card-footer">
      <app-pagination [config]="paginationConfig" (pageChange)="handlePageChange($event)"
        (pageSizeChange)="selectPageSize($event)">
      </app-pagination>
    </div>
    }
  </div>
</div>