<div class="read-mail-page">
    <div class="container">
        <div class="page-header">
            <h1><i class="bi bi-inbox me-2"></i> Đọc Hòm Thư</h1>
            <p>Đọc danh sách email từ hòm thư Hotmail/Outlook</p>
        </div>

        <div class="read-mail-card">
            <form [formGroup]="readMailForm" (ngSubmit)="onReadMail()" class="read-mail-form">
                <!-- Message Count -->
                <div class="form-row">
                    <label class="form-label">Số lượng email mỗi hòm thư</label>
                    <div class="message-count-input">
                        <input type="number" formControlName="messageCount" min="5" max="50" class="count-input">
                        <span class="count-hint">emails (5-50)</span>
                    </div>
                </div>

                <!-- Email Data Textarea -->
                <div class="form-row">
                    <label class="form-label">Email <span class="email-count">[{{ emailCount }}]</span></label>
                    <textarea formControlName="emailData" class="email-textarea" rows="8"
                        placeholder="email|password|refresh_token|client_id"></textarea>
                    <div class="textarea-hint">
                        <i class="bi bi-info-circle me-1"></i>
                        Định dạng: email|password|refresh_token|client_id (mỗi dòng một email)
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    @if (isLoading) {
                    <button type="button" class="stop-btn" (click)="stopReadMail()">
                        <i class="bi bi-stop-fill me-1"></i> Dừng
                    </button>
                    }
                    @if (showResults) {
                    <button type="button" class="clear-btn" (click)="clearResults()">
                        <i class="bi bi-trash me-1"></i> Clear
                    </button>
                    }
                    <button type="submit" class="read-mail-btn" [disabled]="readMailForm.invalid || isLoading">
                        @if (isLoading) {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Đang đọc... ({{ progressPercent }}%)
                        } @else {
                        <i class="bi bi-envelope-open me-2"></i> Đọc Mail
                        }
                    </button>
                </div>
            </form>

            <!-- Results Section -->
            @if (showResults) {
            <div class="read-mail-results">
                <div class="results-header">
                    <h4><i class="bi bi-list-ul me-2"></i> Kết quả ({{ results.length }})</h4>
                    <div class="results-stats">
                        <span class="stat success"><i class="bi bi-check-circle-fill"></i> {{ successCount }}</span>
                        <span class="stat failed"><i class="bi bi-x-circle-fill"></i> {{ failedCount }}</span>
                    </div>
                </div>

                @if (results.length === 0 && !isLoading) {
                <div class="no-results">
                    <i class="bi bi-inbox"></i>
                    <p>Chưa có kết quả</p>
                </div>
                } @else {
                <div class="results-list">
                    @for (result of results; track result.email; let i = $index) {
                    <div class="mail-account-card" [class.success]="result.status === 'SUCCESS'"
                        [class.failed]="result.status === 'FAILED' || result.status === 'UNKNOWN'">

                        <!-- Account Header -->
                        <div class="account-header" (click)="toggleExpand(result)">
                            <div class="account-info">
                                <span class="account-index">{{ i + 1 }}</span>
                                <div class="account-details">
                                    <span class="account-email">{{ result.email }}</span>
                                    @if (result.success) {
                                    <span class="message-count-badge">
                                        <i class="bi bi-envelope"></i> {{ result.totalMessages }} emails
                                    </span>
                                    } @else {
                                    <span class="error-text">{{ result.error || 'Lỗi không xác định' }}</span>
                                    }
                                </div>
                            </div>
                            <div class="account-actions">
                                <span class="status-badge" [class.success]="result.status === 'SUCCESS'"
                                    [class.error]="result.status === 'FAILED' || result.status === 'UNKNOWN'">
                                    {{ result.status === 'SUCCESS' ? 'Thành công' : 'Thất bại' }}
                                </span>
                                <button type="button" class="expand-btn">
                                    <i class="bi" [class.bi-chevron-down]="!result.expanded"
                                        [class.bi-chevron-up]="result.expanded"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Messages List (Expanded) -->
                        @if (result.expanded && result.messages && result.messages.length > 0) {
                        <div class="messages-list">
                            @for (msg of result.messages; track msg.subject; let j = $index) {
                            <div class="message-item" [class.unread]="!msg.isRead">
                                <div class="message-header">
                                    <span class="message-index">{{ j + 1 }}</span>
                                    <div class="message-from">
                                        <i class="bi bi-person me-1"></i>
                                        {{ msg.from }}
                                    </div>
                                    <div class="message-date">
                                        <i class="bi bi-clock me-1"></i>
                                        {{ msg.date }}
                                    </div>
                                    @if (msg.hasAttachments) {
                                    <span class="attachment-icon" title="Có tệp đính kèm">
                                        <i class="bi bi-paperclip"></i>
                                    </span>
                                    }
                                    <button type="button" class="view-btn"
                                        (click)="openEmailModal(msg, result.email); $event.stopPropagation()"
                                        title="Xem chi tiết">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="message-subject"
                                    (click)="openEmailModal(msg, result.email); $event.stopPropagation()"
                                    title="Xem chi tiết">
                                    <strong>{{ msg.subject || '(Không có tiêu đề)' }}</strong>
                                </div>
                                @if (msg.preview) {
                                <div class="message-preview">{{ msg.preview }}</div>
                                }
                            </div>
                            }
                        </div>
                        }

                        @if (result.expanded && (!result.messages || result.messages.length === 0) && result.success) {
                        <div class="no-messages">
                            <i class="bi bi-inbox"></i>
                            <p>Hòm thư trống</p>
                        </div>
                        }
                    </div>
                    }
                </div>
                }
            </div>
            }
        </div>
    </div>
</div>

<!-- Email Detail Modal -->
@if (showEmailModal && selectedMessage) {
<div class="email-modal-overlay" (click)="closeEmailModal()">
    <div class="email-modal" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="email-modal-header">
            <div class="email-header-info">
                <div class="email-subject-title">{{ selectedMessage.subject || '(Không có tiêu đề)' }}</div>
                <div class="email-meta-info">
                    <span class="from-info"><i class="bi bi-person me-1"></i>{{ selectedMessage.from }}</span>
                    <span class="date-info"><i class="bi bi-clock me-1"></i>{{ selectedMessage.date }}</span>
                </div>
            </div>
            <button type="button" class="close-modal-btn" (click)="closeEmailModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Modal Body - Email HTML Content -->
        <div class="email-modal-body">
            <div class="email-html-content"
                [innerHTML]="selectedMessage.htmlBody || selectedMessage.preview || 'Không có nội dung'"></div>
        </div>
    </div>
</div>
}