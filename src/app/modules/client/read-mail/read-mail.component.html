<div class="read-mail-page">
    <div class="container">
        <div class="page-header">
            <h1><i class="bi bi-inbox me-2"></i> {{ 'TOOLS.READ_MAIL_TITLE' | translate }}</h1>
            <p>{{ 'TOOLS.READ_MAIL_SUBTITLE' | translate }}</p>
        </div>

        <div class="read-mail-card">
            <form [formGroup]="readMailForm" (ngSubmit)="onReadMail()" class="read-mail-form">
                <!-- Message Count -->
                <div class="form-row">
                    <label class="form-label">{{ 'TOOLS.MESSAGE_COUNT_LABEL' | translate }}</label>
                    <div class="message-count-input">
                        <input type="number" formControlName="messageCount" min="5" max="50" class="count-input">
                    </div>
                </div>

                <!-- Email Data Textarea -->
                <div class="form-row">
                    <label class="form-label">{{ 'TOOLS.EMAIL_INPUT_LABEL' | translate }} <span class="email-count">[{{
                            emailCount }}]</span></label>
                    <textarea formControlName="emailData" class="email-textarea" rows="8"
                        placeholder="email|password|refresh_token|client_id"></textarea>
                    <div class="textarea-hint">
                        <i class="bi bi-info-circle me-1"></i>
                        {{ 'TOOLS.INPUT_FORMAT' | translate }}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    @if (isLoading) {
                    <button type="button" class="stop-btn" (click)="stopReadMail()">
                        <i class="bi bi-stop-fill me-1"></i> {{ 'TOOLS.STOP' | translate }}
                    </button>
                    }
                    <button type="submit" class="read-mail-btn" [disabled]="readMailForm.invalid || isLoading">
                        @if (isLoading) {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        {{ 'TOOLS.READING' | translate }}
                        } @else {
                        <i class="bi bi-envelope-open me-2"></i> {{ 'TOOLS.READ_MAIL_BTN' | translate }}
                        }
                    </button>
                </div>
            </form>

            <!-- Progress Bar -->
            @if (showResults && totalCount > 0) {
            <div class="progress-section">
                <div class="progress-info">
                    <span>{{ 'TOOLS.PROGRESS' | translate }}: {{ processedCount }}/{{ totalCount }}</span>
                    <span>{{ progressPercent }}%</span>
                </div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" [style.width.%]="progressPercent"></div>
                </div>
            </div>
            }

            <!-- Results Section -->
            @if (showResults) {
            <div class="read-mail-results">
                <div class="results-header">
                    <h4><i class="bi bi-list-ul me-2"></i> {{ 'TOOLS.RESULTS' | translate }} ({{ results.length }})</h4>
                    <div class="results-actions">
                        <span class="badge bg-success me-2">{{ 'COMMON.SUCCESS' | translate }}: {{ successCount
                            }}</span>
                        <span class="badge bg-danger me-2">{{ 'COMMON.ERROR' | translate }}: {{ failedCount }}</span>
                        <button type="button" class="clear-btn" (click)="clearResults()">
                            <i class="bi bi-trash me-1"></i> {{ 'TOOLS.DELETE' | translate }}
                        </button>
                    </div>
                </div>

                @if (results.length === 0 && !isLoading) {
                <div class="no-results">
                    <i class="bi bi-inbox"></i>
                    <p>{{ 'TOOLS.NO_RESULT' | translate }}</p>
                </div>
                } @else {
                <div class="results-list">
                    @for (result of results; track result.email; let i = $index) {
                    <div class="mail-account-card" [class.success]="result.status === 'SUCCESS'"
                        [class.failed]="result.status === 'FAILED' || result.status === 'UNKNOWN'">

                        <!-- Account Header -->
                        <div class="account-header" (click)="toggleExpand(result)">
                            <div class="account-info">
                                <span class="account-index">{{ i + 1 }}</span>
                                <div class="account-details">
                                    <span class="account-email">{{ result.email }}</span>
                                    @if (result.success) {
                                    <span class="message-count-badge">
                                        <i class="bi bi-envelope"></i> {{ result.totalMessages }} emails
                                    </span>
                                    } @else {
                                    <span class="error-text">{{ result.error || ('TOOLS.UNKNOWN_ERROR' | translate)
                                        }}</span>
                                    }
                                </div>
                            </div>
                            <div class="account-actions">
                                <span class="status-badge" [class.success]="result.status === 'SUCCESS'"
                                    [class.error]="result.status === 'FAILED' || result.status === 'UNKNOWN'">
                                    {{ result.status === 'SUCCESS' ? ('COMMON.SUCCESS' | translate) : ('COMMON.ERROR' |
                                    translate) }}
                                </span>
                                <button type="button" class="expand-btn">
                                    <i class="bi" [class.bi-chevron-down]="!result.expanded"
                                        [class.bi-chevron-up]="result.expanded"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Messages List (Expanded) -->
                        @if (result.expanded && result.messages && result.messages.length > 0) {
                        <div class="messages-list">
                            @for (msg of result.messages; track msg.subject; let j = $index) {
                            <div class="message-item" [class.unread]="!msg.isRead">
                                <div class="message-header">
                                    <span class="message-index">{{ j + 1 }}</span>
                                    <div class="message-from">
                                        <i class="bi bi-person me-1"></i>
                                        {{ msg.from }}
                                    </div>
                                    <div class="message-date">
                                        <i class="bi bi-clock me-1"></i>
                                        {{ msg.date }}
                                    </div>
                                    @if (msg.hasAttachments) {
                                    <span class="attachment-icon" [title]="'TOOLS.HAS_ATTACHMENT' | translate">
                                        <i class="bi bi-paperclip"></i>
                                    </span>
                                    }
                                    <button type="button" class="view-btn"
                                        (click)="openEmailModal(msg, result.email); $event.stopPropagation()"
                                        [title]="'TOOLS.VIEW_DETAIL' | translate">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="message-subject"
                                    (click)="openEmailModal(msg, result.email); $event.stopPropagation()"
                                    [title]="'TOOLS.VIEW_DETAIL' | translate">
                                    <strong>{{ msg.subject || ('TOOLS.NO_SUBJECT' | translate) }}</strong>
                                </div>
                                @if (msg.preview) {
                                <div class="message-preview">{{ msg.preview }}</div>
                                }
                            </div>
                            }
                        </div>
                        }

                        @if (result.expanded && (!result.messages || result.messages.length === 0) && result.success) {
                        <div class="no-messages">
                            <i class="bi bi-inbox"></i>
                            <p>{{ 'TOOLS.EMPTY_INBOX' | translate }}</p>
                        </div>
                        }
                    </div>
                    }
                </div>
                }
            </div>
            }
        </div>
    </div>
</div>

<!-- Email Detail Modal -->
@if (showEmailModal && selectedMessage) {
<div class="email-modal-overlay" (click)="closeEmailModal()">
    <div class="email-modal" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="email-modal-header">
            <div class="email-header-info">
                <div class="email-subject-title">{{ selectedMessage.subject || ('TOOLS.NO_SUBJECT' | translate) }}</div>
                <div class="email-meta-info">
                    <span class="from-info"><i class="bi bi-person me-1"></i>{{ selectedMessage.from }}</span>
                    <span class="date-info"><i class="bi bi-clock me-1"></i>{{ selectedMessage.date }}</span>
                </div>
            </div>
            <button type="button" class="close-modal-btn" (click)="closeEmailModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Modal Body - Email HTML Content -->
        <div class="email-modal-body">
            <div class="email-html-content"
                [innerHTML]="selectedMessage.htmlBody || selectedMessage.preview || ('TOOLS.NO_CONTENT' | translate)">
            </div>
        </div>
    </div>
</div>
}