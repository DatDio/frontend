<!-- 
  IMPORTANT: authReady$ stays FALSE on SSR, only TRUE after browser checks localStorage.
  This prevents SSR from rendering unauthenticated UI that flashes on hydration.
-->

<!-- Loading overlay while auth is not ready (SSR and initial browser load) -->
@if (!(authReady$ | async)) {
<div class="auth-loading-overlay">
  <div class="auth-loading-spinner">
    <div class="spinner-ring"></div>
    <div class="spinner-ring"></div>
    <div class="spinner-ring"></div>
  </div>
</div>
}

<div class="layout-wrapper">
  <div class="client-header-sticky">
    <nav class="navbar navbar-expand-lg client-navbar">
      <div class="container">
        <a class="navbar-brand" routerLink="/">
          Email Siêu Rẻ <img src="assets/images/emailsieure_icon.png" alt="EmailSieuRe"> Email Super Cheap
        </a>

        <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Desktop navbar -->
        <div class="collapse navbar-collapse d-none d-lg-flex" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-2">
            <!-- Language Switcher -->
            <li class="nav-item">
              <app-language-switcher></app-language-switcher>
            </li>
            <!-- Theme Toggle -->
            <li class="nav-item">
              <button class="theme-toggle-btn" (click)="toggleTheme()" [title]="'COMMON.SWITCH_THEME' | translate">
                <i class="bi" [class.bi-sun-fill]="(theme$ | async) === 'dark'"
                  [class.bi-moon-fill]="(theme$ | async) === 'light'"></i>
              </button>
            </li>
            <!-- Tools Dropdown -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                <i class="bi bi-tools me-1"></i>{{ 'COMMON.TOOLS' | translate }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" routerLink="/get-code-mail"><i class="bi bi-code-slash me-2"></i>{{
                    'TOOLS.GET_CODE_MAIL' | translate }}</a></li>
                <li><a class="dropdown-item" routerLink="/check-live-facebook"><i class="bi bi-facebook me-2"></i>{{
                    'TOOLS.CHECK_LIVE_FB' | translate }}</a></li>
                <li><a class="dropdown-item" routerLink="/check-live-mail"><i class="bi bi-envelope-fill me-2"></i>{{
                    'TOOLS.CHECK_LIVE_MAIL' | translate }}</a></li>
                <li><a class="dropdown-item" routerLink="/get-2fa"><i class="bi bi-shield-lock-fill me-2"></i>{{
                    'TOOLS.GET_2FA' | translate }}</a></li>
                <li><a class="dropdown-item" routerLink="/get-oauth2"><i class="bi bi-key-fill me-2"></i>{{
                    'TOOLS.GET_OAUTH2' | translate }}</a></li>
                <li><a class="dropdown-item" routerLink="/read-mail"><i class="bi bi-inbox-fill me-2"></i>{{
                    'TOOLS.READ_MAIL' | translate }}</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" routerLink="/tools"><i class="bi bi-grid-fill me-2"></i>{{ 'TOOLS.VIEW_ALL'
                    |
                    translate }}</a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://docs.emailsieure.com/" target="_blank" rel="noopener noreferrer">
                {{ 'COMMON.API_DOCS' | translate }}
              </a>
            </li>

            @if (authReady$ | async) {
            @if (isAuthenticated$ | async) {
            <li class="nav-item d-flex align-items-center">
              <div class="balance-info-navbar">
                <i class="bi bi-wallet2 me-1"></i>
                {{ balance$ | async | vndUsd }}
              </div>
            </li>

            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                {{ (authService.currentUser$ | async)?.email }}
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                @if (authService.isAdmin()) {
                <li><a class="dropdown-item" routerLink="/admin">{{ 'COMMON.ADMIN' | translate }}</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                }
                <li><a class="dropdown-item" routerLink="/profile">{{ 'COMMON.PROFILE' | translate }}</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" (click)="logout()">{{ 'AUTH.LOGOUT' | translate }}</a></li>
              </ul>
            </li>
            } @else {
            <li class="nav-item">
              <a class="nav-link" routerLink="/auth/login">{{ 'AUTH.LOGIN' | translate }}</a>
            </li>
            <li class="nav-item">
              <a class="btn custom-signup-btn btn-sm" routerLink="/auth/register">{{ 'AUTH.REGISTER' | translate }}</a>
            </li>
            }
            } @else {
            <li class="nav-item">
              <div class="nav-placeholder"></div>
            </li>
            }
          </ul>
        </div>
      </div>
    </nav>

    <!-- Mobile Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start mobile-sidebar" tabindex="-1" id="mobileMenu">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">EmailSieuRe.Com</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        @if (authReady$ | async) {
        @if (isAuthenticated$ | async) {
        <div class="balance-info-sidebar mb-3">
          <i class="bi bi-wallet2 me-2"></i>
          {{ balance$ | async | vndUsd }}
        </div>
        <div class="user-email-sidebar mb-3">
          <i class="bi bi-person-circle me-2"></i>
          {{ (authService.currentUser$ | async)?.email }}
        </div>
        <hr>
        <nav class="nav flex-column sidebar-nav">
          <a class="nav-link" routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}"
            data-bs-dismiss="offcanvas">
            <i class="bi bi-house-door-fill me-2"></i>{{ 'COMMON.HOME' | translate }}
          </a>
          <a class="nav-link" routerLink="/profile" routerLinkActive="active" data-bs-dismiss="offcanvas">
            <i class="bi bi-person-fill me-2"></i>{{ 'COMMON.PROFILE' | translate }}
          </a>
          <a class="nav-link" routerLink="/transactions" routerLinkActive="active" data-bs-dismiss="offcanvas">
            <i class="bi bi-credit-card-fill me-2"></i>{{ 'COMMON.DEPOSIT' | translate }}
          </a>
          <a class="nav-link" routerLink="/orders" routerLinkActive="active" data-bs-dismiss="offcanvas">
            <i class="bi bi-cart-fill me-2"></i>{{ 'COMMON.ORDER_HISTORY' | translate }}
          </a>
          <a class="nav-link" routerLink="/ranks" routerLinkActive="active" data-bs-dismiss="offcanvas">
            <i class="bi bi-trophy-fill me-2"></i>{{ 'COMMON.RANK' | translate }}
          </a>
          <a class="nav-link" routerLink="/tools" routerLinkActive="active" data-bs-dismiss="offcanvas">
            <i class="bi bi-tools me-2"></i>{{ 'COMMON.TOOLS' | translate }}
          </a>
          <a class="nav-link" routerLink="/support" routerLinkActive="active" data-bs-dismiss="offcanvas">
            <i class="bi bi-headset me-2"></i>{{ 'COMMON.SUPPORT' | translate }}
          </a>
          <hr>
          <a class="nav-link" href="https://dat-dio.gitbook.io/EmailSieuRedocs" target="_blank"
            rel="noopener noreferrer">
            <i class="bi bi-book me-2"></i>{{ 'COMMON.API_DOCS' | translate }}
          </a>
          <!-- Theme Toggle in Sidebar -->
          <a class="nav-link" (click)="toggleTheme()">
            <i class="bi me-2" [class.bi-sun-fill]="(theme$ | async) === 'dark'"
              [class.bi-moon-fill]="(theme$ | async) === 'light'"></i>
            {{ (theme$ | async) === 'dark' ? ('COMMON.LIGHT_THEME' | translate) : ('COMMON.DARK_THEME' | translate) }}
          </a>
          <!-- Language Toggle in Sidebar -->
          <a class="nav-link" (click)="toggleLanguage()">
            <i class="bi bi-globe me-2"></i>
            {{ (currentLang$ | async) === 'vi' ? '🇬🇧 English' : '🇻🇳 Tiếng Việt' }}
          </a>
          <a class="nav-link text-danger" (click)="logout()" data-bs-dismiss="offcanvas">
            <i class="bi bi-box-arrow-right me-2"></i>{{ 'AUTH.LOGOUT' | translate }}
          </a>
        </nav>
        } @else {
        <nav class="nav flex-column sidebar-nav">
          <a class="nav-link" routerLink="/auth/login" data-bs-dismiss="offcanvas">
            <i class="bi bi-box-arrow-in-right me-2"></i>{{ 'AUTH.LOGIN' | translate }}
          </a>
          <a class="nav-link" routerLink="/auth/register" data-bs-dismiss="offcanvas">
            <i class="bi bi-person-plus me-2"></i>{{ 'AUTH.REGISTER' | translate }}
          </a>
          <hr>
          <a class="nav-link" href="https://dat-dio.gitbook.io/EmailSieuRedocs" target="_blank"
            rel="noopener noreferrer">
            <i class="bi bi-book me-2"></i>{{ 'COMMON.API_DOCS' | translate }}
          </a>
        </nav>
        }
        }
      </div>
    </div>

    <!-- Hero section - only show when authReady AND authenticated -->
    @if (authReady$ | async) {
    @if (isAuthenticated$ | async) {
    <section class="hero-section d-none d-lg-block">
      <div class="container">
        <div class="hero-menu">
          <a routerLink="/" class="hero-link" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">
            <i class="bi bi-house-door-fill"></i>
            <span>{{ 'COMMON.HOME' | translate }}</span>
          </a>
          <a routerLink="/profile" class="hero-link" routerLinkActive="active">
            <i class="bi bi-person-fill"></i>
            <span>{{ 'COMMON.PROFILE' | translate }}</span>
          </a>
          <a routerLink="/transactions" class="hero-link" routerLinkActive="active">
            <i class="bi bi-credit-card-fill"></i>
            <span>{{ 'COMMON.DEPOSIT' | translate }}</span>
          </a>
          <a routerLink="/orders" class="hero-link" routerLinkActive="active">
            <i class="bi bi-cart-fill"></i>
            <span>{{ 'COMMON.ORDER_HISTORY' | translate }}</span>
          </a>
          <a routerLink="/ranks" class="hero-link" routerLinkActive="active">
            <i class="bi bi-trophy-fill"></i>
            <span>{{ 'COMMON.RANK' | translate }}</span>
          </a>
          <a routerLink="/support" class="hero-link" routerLinkActive="active">
            <i class="bi bi-headset"></i>
            <span>{{ 'COMMON.SUPPORT' | translate }}</span>
          </a>
          <a routerLink="/collaborator" class="hero-link" routerLinkActive="active">
            <i class="bi bi-people-fill"></i>
            <span>{{ 'COMMON.COLLABORATOR' | translate }}</span>
          </a>
        </div>
      </div>
    </section>
    }
    }
  </div>

  <!-- Main content -->
  <main class="client-main container my-4">
    @if (authReady$ | async) {
    <router-outlet></router-outlet>
    } @else {
    <!-- Skeleton while auth loading -->
    <div class="content-skeleton">
      <div class="skeleton-header"></div>
      <div class="skeleton-body">
        <div class="skeleton-line"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </div>
    </div>
    }
  </main>

  <footer class="client-footer">
    <div class="container">
      <div class="row text-center text-md-start">
        <div class="col-md-4 mb-3">
          <h5>EmailSieuRe.Com</h5>
          <p [innerHTML]="'FOOTER.ABOUT' | translate"></p>
        </div>
        <div class="col-md-4 mb-3">
          <h6>{{ 'FOOTER.QUICK_LINKS' | translate }}</h6>
          <ul class="list-unstyled">
            <li><a routerLink="/">{{ 'COMMON.HOME' | translate }}</a></li>
            <li><a routerLink="/terms-of-service">{{ 'FOOTER.TERMS_OF_SERVICE' | translate }}</a></li>
            <li><a routerLink="/policy">{{ 'FOOTER.PRIVACY_POLICY' | translate }}</a></li>
          </ul>
        </div>
        <div class="col-md-4 mb-3">
          <h6 class="mr-2">{{ 'FOOTER.CONTACT' | translate }}</h6>
          <ul class="list-unstyled">
            <li>
              <a [href]="telegramGroupUrl" target="_blank" rel="noopener noreferrer">
                <i class="bi bi-telegram me-2"></i>{{ 'FOOTER.GROUP_CHAT' | translate }}
              </a>
            </li>
            <li>
              <a [href]="telegramChannelUrl" target="_blank" rel="noopener noreferrer">
                <i class="bi bi-telegram me-2"></i>{{ 'FOOTER.CONTACT_ADMIN' | translate }}
              </a>
            </li>
          </ul>

        </div>
      </div>
      <hr>
      <div class="text-center"><small>© 2025 EmailSieuRe | Made with ❤️ by DatDio</small></div>
    </div>
  </footer>
</div>